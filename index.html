<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>–ú–∞–≥–∞–∑–∏–Ω "100 –†–µ–Ω—Ç–≥–µ–Ω"</title>
<style>
  :root{
    --accent:#ff9800;
    --bg:#850000;
    --panel-bg:rgba(18,18,18,0.96);
    --muted:#9aa;
    --card:#101010;
    --glass: rgba(255,255,255,0.03);
  }
  *{box-sizing:border-box}
  html,body{height:100%;margin:0;font-family:Inter,system-ui,Arial,sans-serif;background:url('https://i.imgur.com/Z1OWJQa.png') center/cover fixed;color:#fff}
  a{color:inherit}
  button,input,select,textarea{font:inherit}
  button{cursor:pointer}

  header{display:flex;justify-content:space-between;align-items:flex-start;padding:12px 18px;background:linear-gradient(180deg,rgba(0,0,0,0.6),rgba(0,0,0,0.2));gap:12px;position:sticky;top:0;z-index:40}
  .brand{display:flex;flex-direction:column}
  .brand h1{margin:0;font-size:18px}
  .controls{display:flex;flex-direction:column;align-items:flex-end;gap:8px}
  .top-buttons{display:flex;gap:8px}

  .categoryFilter{display:flex;gap:8px;align-items:center;overflow:auto;max-width:720px;padding-bottom:6px}
  .categoryFilter button{background:transparent;border:1px solid var(--glass);padding:6px 10px;border-radius:8px;color:#fff}
  .categoryFilter button.active{background:var(--accent);color:#000}

  .subcategoryContainer{margin-top:8px}
  .subcategoryFilter{display:flex;gap:6px;flex-wrap:wrap;max-height:88px;overflow:auto;padding:6px}
  .subcategoryFilter button{background:transparent;border:1px solid var(--glass);padding:6px 8px;border-radius:6px;color:#fff;font-size:13px}
  .subcategoryFilter button.active{background:var(--accent);color:#000}

  .container{padding:18px;display:flex;gap:18px;flex-wrap:wrap;justify-content:flex-start}
  .product-list{display:flex;flex-wrap:wrap;gap:18px}
  .product{width:220px;background:var(--panel-bg);padding:10px;border-radius:10px;border:1px solid var(--glass);cursor:pointer;transition:transform .12s}
  .product:hover{transform:translateY(-6px)}
  .product img{width:100%;height:140px;object-fit:cover;border-radius:6px}
  .product h3{margin:8px 0 4px;font-size:15px}
  .product p{margin:2px 0;color:var(--muted);font-size:13px}

  .panel{position:fixed;right:14px;top:72px;width:520px;max-height:80vh;overflow:auto;background:var(--panel-bg);padding:12px;border-radius:10px;border:1px solid var(--glass);display:none;z-index:60}
  @media(max-width:980px){ .panel{left:14px;right:14px;width:auto} .product{width:calc(50% - 24px)} }

  .list-item{display:flex;justify-content:space-between;gap:8px;padding:8px;border-radius:8px;border:1px solid var(--glass);margin-top:8px;background:linear-gradient(180deg,#0c0c0c,#0a0a0a)}

  .overlay{position:fixed;inset:0;background:rgba(0,0,0,0.6);backdrop-filter:blur(3px);display:none;z-index:80}
  .modal{position:fixed;left:50%;top:50%;transform:translate(-50%,-50%);background:#0b0b0b;padding:16px;border-radius:10px;border:1px solid var(--glass);z-index:90;display:none;max-width:920px;width:92%;max-height:92vh;overflow:auto}
  .modal .close{position:absolute;right:10px;top:8px;background:transparent;border:1px solid var(--glass);color:#fff;padding:6px;border-radius:6px}
  .modal h2{margin:0 0 8px}

  .product-view{
    display:flex;
    gap:24px;
    align-items:flex-start;
    flex-wrap: wrap;
  }
  .product-view-left{
    min-width: 320px;
    flex: 1;
    display: flex;
    justify-content: center;
  }
  .product-view-left img{
    width: 100%;
    max-width: 400px;
    height: 350px;
    object-fit: contain;
    border-radius: 10px;
    background: var(--card);
    padding: 12px;
    border: 1px solid var(--glass);
  }
  .product-view-right{
    flex: 1;
    min-width: 300px;
  }
  .product-view-right h3{
    margin:0 0 12px;
    font-size: 20px;
  }
  .muted{
    color:var(--muted);
    font-size:14px;
  }

  .attach-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(150px,1fr));gap:10px;margin-top:8px}
  .attach-card{background:#0d0d0d;border:1px solid var(--glass);padding:8px;border-radius:8px;display:flex;flex-direction:column;align-items:center;text-align:center;transition:.12s}
  .attach-card img{width:90px;height:90px;object-fit:cover;border-radius:6px}
  .attach-card .title{margin-top:8px;font-size:13px}
  .attach-card .price{font-size:13px;color:var(--muted)}
  .attach-card .row{margin-top:8px;display:flex;align-items:center;gap:6px}
  .attach-card.selected{border:2px solid var(--accent);background:linear-gradient(180deg, rgba(26,18,0,0.15), rgba(0,0,0,0.05))}

  .form-row{display:flex;gap:8px;flex-wrap:wrap}
  .form-col{flex:1;min-width:160px}
  input,select,textarea{width:100%;padding:8px;border-radius:8px;border:1px solid #222;background:#080808;color:#fff}
  textarea{min-height:80px}

  .btn{background:var(--accent);color:#000;padding:8px;border-radius:8px;border:none}
  .ghost{background:transparent;border:1px solid var(--glass);color:#fff;padding:6px;border-radius:6px}

  .small-muted{font-size:12px;color:var(--muted);margin-top:6px}
  .attach-row{display:flex;gap:8px;align-items:center;margin-top:8px}
  .attach-row input[type="text"], .attach-row input[type="number"], .attach-row select{padding:6px;border-radius:6px;background:#080808;border:1px solid #222;color:#fff}
  .msg-box{margin-top:8px;display:flex;gap:8px}
  .chat-note{margin-top:6px;font-size:13px;color:#ffdca8}
</style>
</head>
<body>

<header>
  <div class="brand">
    <h1>100 –†–µ–Ω—Ç–≥–µ–Ω ‚Äî –≤–Ω—É—Ç—Ä–∏–∏–≥—Ä–æ–≤–æ–π –º–∞–≥–∞–∑–∏–Ω</h1>
    <div class="muted">–ú–∏–Ω–∏–º–∞–ª–∏—Å—Ç–∏—á–Ω—ã–π –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å ‚Äî —Ä–∞–±–æ—á–∞—è –≤–µ—Ä—Å–∏—è</div>
  </div>

  <div class="controls">
    <div class="top-buttons">
      <button id="btnCart" class="ghost">–ö–æ—Ä–∑–∏–Ω–∞</button>
      <button id="btnLogin" class="ghost">–í—Ö–æ–¥</button>
      <button id="btnMyOrders" class="ghost" style="display:none">–ú–æ–∏ –∑–∞—è–≤–∫–∏</button>
      <button id="btnSeller" class="ghost">–ü–∞–Ω–µ–ª—å –ø—Ä–æ–¥–∞–≤—Ü–∞</button>
    </div>

    <div class="categoryFilter" id="categoryFilter"></div>
    <div class="subcategoryContainer" id="subcategoryContainer"></div>
  </div>
</header>

<main class="container">
  <div id="productList" class="product-list"></div>
</main>

<div id="overlay" class="overlay"></div>

<div id="productModalView" class="modal" aria-hidden="true">
  <button class="close" id="closeProductView">‚úï</button>
  <div id="productViewContent"></div>
</div>

<div id="productModalEdit" class="modal" aria-hidden="true">
  <button class="close" id="closeProductEdit">‚úï</button>
  <h2 id="editTitle">–î–æ–±–∞–≤–∏—Ç—å / –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —Ç–æ–≤–∞—Ä</h2>
  <div id="productEditForm"></div>
</div>

<div id="cartPanel" class="panel">
  <h3>–ö–æ—Ä–∑–∏–Ω–∞</h3>
  <div id="cartItems"></div>
  <p>–ò—Ç–æ–≥–æ: <b id="cartTotal">0</b> üí∞</p>
  <div style="display:flex;gap:8px;justify-content:flex-end">
    <button id="btnCheckout" class="btn">–û—Ñ–æ—Ä–º–∏—Ç—å –∑–∞—è–≤–∫—É</button>
  </div>
</div>

<div id="loginPanel" class="panel">
  <h3>–í—Ö–æ–¥ / –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</h3>
  <input id="username" placeholder="–ò–º—è" />
  <input id="password" placeholder="–ü–∞—Ä–æ–ª—å" type="password" />
  <div style="display:flex;gap:8px;margin-top:8px">
    <button id="btnRegister" class="btn">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</button>
    <button id="btnSignIn" class="btn">–í–æ–π—Ç–∏</button>
  </div>
</div>

<div id="myOrdersPanel" class="panel">
  <h3>–ú–æ–∏ –∑–∞—è–≤–∫–∏</h3>
  <div id="myOrdersList"></div>
</div>

<div id="sellerPanel" class="panel">
  <h3>–ü–∞–Ω–µ–ª—å –ø—Ä–æ–¥–∞–≤—Ü–∞</h3>
  <div id="sellerLoginArea">
    <input id="sellerPass" placeholder="–ü–∞—Ä–æ–ª—å –ø—Ä–æ–¥–∞–≤—Ü–∞" type="password" />
    <div style="display:flex;gap:8px;margin-top:8px">
      <button id="btnSellerLogin" class="btn">–í–æ–π—Ç–∏</button>
      <button id="btnSellerCancel" class="ghost">–ó–∞–∫—Ä—ã—Ç—å</button>
    </div>
  </div>

  <div id="sellerArea" style="display:none;margin-top:12px">
    <div style="display:flex;gap:8px;margin-bottom:8px">
      <button id="tabOrders" class="ghost">–ó–∞—è–≤–∫–∏</button>
      <button id="tabProducts" class="ghost">–¢–æ–≤–∞—Ä—ã</button>
      <button id="tabCategories" class="ghost">–ö–∞—Ç–µ–≥–æ—Ä–∏–∏</button>
      <button id="btnSellerLogout" class="ghost" style="margin-left:auto">–í—ã–π—Ç–∏</button>
    </div>

    <div id="sellerOrdersSection">
      <div id="ordersList"></div>
    </div>

    <div id="sellerProductsSection" style="display:none">
      <div id="productsEditorList"></div>
      <div style="margin-top:12px">
        <button id="btnNewProduct" class="btn">‚ûï –î–æ–±–∞–≤–∏—Ç—å —Ç–æ–≤–∞—Ä</button>
      </div>
    </div>

    <div id="sellerCategoriesSection" style="display:none">
      <div style="margin-top:6px">
        <strong>–û—Å–Ω–æ–≤–Ω—ã–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏</strong>
        <div id="mainCategoriesList"></div>
        <div style="display:flex;gap:8px;margin-top:8px">
          <input id="newMainCat" placeholder="–î–æ–±–∞–≤–∏—Ç—å –∫–∞—Ç–µ–≥–æ—Ä–∏—é" />
          <button id="btnAddMainCat" class="btn">–î–æ–±–∞–≤–∏—Ç—å</button>
        </div>
      </div>

      <div style="margin-top:12px">
        <strong>–ü–æ–¥–∫–∞—Ç–µ–≥–æ—Ä–∏–∏ (–≤—ã–±–µ—Ä–∏—Ç–µ –æ—Å–Ω–æ–≤–Ω—É—é)</strong>
        <select id="subForMain"></select>
        <div id="subCatsList" style="margin-top:8px;max-height:180px;overflow:auto"></div>
        <div style="display:flex;gap:8px;margin-top:8px">
          <input id="newSubCat" placeholder="–î–æ–±–∞–≤–∏—Ç—å –ø–æ–¥–∫–∞—Ç–µ–≥–æ—Ä–∏—é" />
          <button id="btnAddSubCat" class="btn">–î–æ–±–∞–≤–∏—Ç—å</button>
        </div>
      </div>

      <div style="margin-top:12px">
        <strong>–¢–∏–ø—ã –æ–±–≤–µ—Å–æ–≤</strong>
        <div id="attachTypesList"></div>
        <div style="display:flex;gap:8px;margin-top:8px">
          <input id="newAttachType" placeholder="–î–æ–±–∞–≤–∏—Ç—å —Ç–∏–ø –æ–±–≤–µ—Å–∞" />
          <button id="btnAddAttachType" class="btn">–î–æ–±–∞–≤–∏—Ç—å</button>
        </div>
      </div>
    </div>
  </div>
</div>

<script>// üîß –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø - –ó–ê–ú–ï–ù–ò–¢–ï –≠–¢–û!
const JSONBIN_BIN_ID = '6904b160ae596e708f3a36bf '; // –ù–∞–ø—Ä–∏–º–µ—Ä: '67a1b2c3d4e5f6a7b8c9d0e1'
const JSONBIN_MASTER_KEY = '$2a$10$wTicXNpl/tYWk2p1tuUuC.w87l4en0x8a9e7STVUKFIfFQnaZFdLC'; // –ò–∑ –Ω–∞—Å—Ç—Ä–æ–µ–∫ jsonbin.io


// üì¶ –î–ê–ù–ù–´–ï –ü–û –£–ú–û–õ–ß–ê–ù–ò–Æ
let shopData = {
    products: [],
    users: {},
    orders: {},
    chats: {}
};

let categories = {
    mains: [
        {id:'weapon', title:'–û—Ä—É–∂–∏–µ'},
        {id:'armor', title:'–ë—Ä–æ–Ω—è'},
        {id:'attachments', title:'–û–±–≤–µ—Å—ã'},
        {id:'consumable', title:'–†–∞—Å—Ö–æ–¥–Ω–∏–∫–∏'}
    ],
    subs: {
        weapon: [
            {id:'sniper', title:'–°–Ω–∞–π–ø–µ—Ä—Å–∫–∏–µ'},
            {id:'assault', title:'–®—Ç—É—Ä–º–æ–≤—ã–µ'},
            {id:'smg', title:'–ü–ü'},
            {id:'pistol', title:'–ü–∏—Å—Ç–æ–ª–µ—Ç—ã'}
        ],
        armor: [
            {id:'body', title:'–ë—Ä–æ–Ω—è'},
            {id:'helmet', title:'–®–ª–µ–º—ã'}
        ]
    },
    attachTypes: ['–ü—Ä–∏—Ü–µ–ª—ã','–†—É—á–∫–∏','–ü—Ä–∏–∫–ª–∞–¥—ã']
};

let currentUser = null;
let cart = [];
let selectedCategory = 'all';
let selectedSubcategory = null;
const sellerPassword = 'admin123';

// üì° JSONBIN.IO –§–£–ù–ö–¶–ò–ò
async function loadFromJSONBin() {
    try {
        console.log('–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö –∏–∑ JSONBin...');
        
        const response = await fetch(`https://api.jsonbin.io/v3/b/${JSONBIN_BIN_ID}/latest`, {
            headers: { 
                'X-Master-Key': JSONBIN_MASTER_KEY
            }
        });
        
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        const result = await response.json();
        console.log('–î–∞–Ω–Ω—ã–µ –ø–æ–ª—É—á–µ–Ω—ã –∏–∑ –æ–±–ª–∞–∫–∞');
        
        // –ë–µ–∑–æ–ø–∞—Å–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö
        if (result.record) {
            shopData = result.record;
        }
        
        return true;
        
    } catch (error) {
        console.log('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏–∑ JSONBin:', error.message);
        return false;
    }
}

async function saveToJSONBin() {
    try {
        const response = await fetch(`https://api.jsonbin.io/v3/b/${JSONBIN_BIN_ID}`, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json',
                'X-Master-Key': JSONBIN_MASTER_KEY
            },
            body: JSON.stringify(shopData)
        });
        
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        console.log('‚úÖ –î–∞–Ω–Ω—ã–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã –≤ JSONBin!');
        return true;
        
    } catch (error) {
        console.error('‚ùå –û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –≤ JSONBin:', error);
        return false;
    }
}

// üíæ –°–û–•–†–ê–ù–ï–ù–ò–ï –î–ê–ù–ù–´–•
async function saveData() {
    // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ JSONBin (–æ–±–ª–∞–∫–æ)
    await saveToJSONBin();
}

// üéØ –í–°–ü–û–ú–û–ì–ê–¢–ï–õ–¨–ù–´–ï –§–£–ù–ö–¶–ò–ò
function el(id) { return document.getElementById(id); }
function escapeHtml(text) { return String(text||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }

// üì± –ü–ê–ù–ï–õ–ò –ò –ú–û–î–ê–õ–¨–ù–´–ï –û–ö–ù–ê
function closeAllPanels() {
    ['cartPanel','loginPanel','myOrdersPanel','sellerPanel'].forEach(id => {
        if (el(id)) el(id).style.display = 'none';
    });
    if (el('overlay')) el('overlay').style.display = 'none';
}

function togglePanel(panelId) {
    closeAllPanels();
    if (el(panelId)) el(panelId).style.display = 'block';
    if (el('overlay')) el('overlay').style.display = 'block';
}

// üóÇÔ∏è –ö–ê–¢–ï–ì–û–†–ò–ò –ò –§–ò–õ–¨–¢–†–´
function renderCategoryFilter() {
    const wrap = el('categoryFilter');
    if (!wrap) return;
    
    wrap.innerHTML = '';
    
    const allBtn = document.createElement('button');
    allBtn.textContent = '–í—Å–µ';
    allBtn.className = selectedCategory === 'all' ? 'active' : '';
    allBtn.onclick = () => {
        selectedCategory = 'all';
        selectedSubcategory = null;
        renderCategoryFilter();
        renderSubcats(null);
        renderProducts();
    };
    wrap.appendChild(allBtn);
    
    categories.mains.forEach(cat => {
        const btn = document.createElement('button');
        btn.textContent = cat.title;
        btn.className = selectedCategory === cat.id ? 'active' : '';
        btn.onclick = () => {
            selectedCategory = cat.id;
            selectedSubcategory = null;
            renderCategoryFilter();
            renderSubcats(cat.id);
            renderProducts();
        };
        wrap.appendChild(btn);
    });
}

function renderSubcats(mainId) {
    const container = el('subcategoryContainer');
    if (!container) return;
    
    container.innerHTML = '';
    
    if (!mainId || !categories.subs[mainId]) return;
    
    const wrap = document.createElement('div');
    wrap.className = 'subcategoryFilter';
    
    const allBtn = document.createElement('button');
    allBtn.textContent = '–í—Å–µ –ø–æ–¥–∫–∞—Ç–µ–≥–æ—Ä–∏–∏';
    allBtn.className = selectedSubcategory === null ? 'active' : '';
    allBtn.onclick = () => {
        selectedSubcategory = null;
        renderProducts();
    };
    wrap.appendChild(allBtn);
    
    categories.subs[mainId].forEach(sub => {
        const btn = document.createElement('button');
        btn.textContent = sub.title;
        btn.className = selectedSubcategory === sub.id ? 'active' : '';
        btn.onclick = () => {
            selectedSubcategory = sub.id;
            renderProducts();
        };
        wrap.appendChild(btn);
    });
    
    container.appendChild(wrap);
}

// üéØ –û–¢–û–ë–†–ê–ñ–ï–ù–ò–ï –¢–û–í–ê–†–û–í
function renderProducts() {
    const container = el('productList');
    if (!container) return;
    
    container.innerHTML = '';
    
    const filteredProducts = shopData.products.filter(product => {
        if (selectedCategory !== 'all' && product.category !== selectedCategory) return false;
        if (selectedSubcategory && product.subcategory !== selectedSubcategory) return false;
        return true;
    });
    
    if (filteredProducts.length === 0) {
        container.innerHTML = '<div class="muted">–¢–æ–≤–∞—Ä—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</div>';
        return;
    }
    
    filteredProducts.forEach(product => {
        const productDiv = document.createElement('div');
        productDiv.className = 'product';
        productDiv.onclick = () => openProductView(product.id);
        
        productDiv.innerHTML = `
            <img src="${product.img || 'https://picsum.photos/300/200?random=' + product.id}" alt="${product.name}">
            <h3>${product.name}</h3>
            <p class="muted">${getCatTitle(product.category)}</p>
            <p><b>${product.price} ‚ÇΩ</b></p>
        `;
        container.appendChild(productDiv);
    });
}

function getCatTitle(id) {
    const cat = categories.mains.find(c => c.id === id);
    return cat ? cat.title : id;
}

// üë§ –°–ò–°–¢–ï–ú–ê –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–ï–ô
async function handleLogin() {
    const username = el('username').value.trim();
    const password = el('password').value.trim();
    
    if (!username || !password) {
        alert('–í–≤–µ–¥–∏—Ç–µ –ª–æ–≥–∏–Ω –∏ –ø–∞—Ä–æ–ª—å');
        return;
    }
    
    // –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –∏–ª–∏ –≤—Ö–æ–¥
    if (!shopData.users[username]) {
        shopData.users[username] = { password, orders: [] };
        await saveData(); // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ JSONBin
        alert('–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è —É—Å–ø–µ—à–Ω–∞!');
    }
    
    if (shopData.users[username].password === password) {
        currentUser = username;
        el('btnMyOrders').style.display = 'inline-block';
        closeAllPanels();
        alert(`–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å, ${username}!`);
    } else {
        alert('–ù–µ–≤–µ—Ä–Ω—ã–π –ø–∞—Ä–æ–ª—å');
    }
}

// üõí –ö–û–†–ó–ò–ù–ê
function addToCart(productId) {
    if (!currentUser) {
        alert('–í–æ–π–¥–∏—Ç–µ –¥–ª—è –ø–æ–∫—É–ø–∫–∏');
        togglePanel('loginPanel');
        return;
    }
    
    const product = shopData.products.find(p => p.id === productId);
    if (product) {
        cart.push({
            id: product.id,
            name: product.name,
            price: product.price,
            qty: 1
        });
        updateCartUI();
        alert('–¢–æ–≤–∞—Ä –¥–æ–±–∞–≤–ª–µ–Ω –≤ –∫–æ—Ä–∑–∏–Ω—É!');
    }
}

function updateCartUI() {
    const cartItems = el('cartItems');
    const total = el('cartTotal');
    
    if (!cartItems || !total) return;
    
    cartItems.innerHTML = '';
    let sum = 0;
    
    cart.forEach((item, index) => {
        sum += item.price * item.qty;
        const itemDiv = document.createElement('div');
        itemDiv.className = 'list-item';
        itemDiv.innerHTML = `
            <div style="flex:1">
                <b>${item.name}</b>
                <div class="muted">${item.price} ‚ÇΩ √ó ${item.qty}</div>
            </div>
            <div>
                <b>${item.price * item.qty} ‚ÇΩ</b>
                <button class="ghost" onclick="removeFromCart(${index})" style="margin-left:8px">‚ùå</button>
            </div>
        `;
        cartItems.appendChild(itemDiv);
    });
    
    total.textContent = sum;
}

function removeFromCart(index) {
    cart.splice(index, 1);
    updateCartUI();
}

async function checkout() {
    if (!currentUser) {
        alert('–í–æ–π–¥–∏—Ç–µ –¥–ª—è –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏—è –∑–∞–∫–∞–∑–∞');
        return;
    }
    
    if (cart.length === 0) {
        alert('–ö–æ—Ä–∑–∏–Ω–∞ –ø—É—Å—Ç–∞');
        return;
    }
    
    const order = {
        id: Date.now(),
        items: [...cart],
        total: cart.reduce((sum, item) => sum + (item.price * item.qty), 0),
        timestamp: new Date().toISOString(),
        status: 'new'
    };
    
    shopData.users[currentUser].orders.push(order);
    shopData.orders[order.id] = order;
    
    await saveData(); // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ JSONBin
    
    cart = [];
    updateCartUI();
    closeAllPanels();
    
    alert(`–ó–∞–∫–∞–∑ #${order.id} –æ—Ñ–æ—Ä–º–ª–µ–Ω!`);
}

// üëë –ü–ê–ù–ï–õ–¨ –ü–†–û–î–ê–í–¶–ê
async function handleSellerLogin() {
    const password = el('sellerPass').value;
    
    if (password === sellerPassword) {
        el('sellerLoginArea').style.display = 'none';
        el('sellerArea').style.display = 'block';
        renderSellerProducts();
        renderCategoriesEditor();
    } else {
        alert('–ù–µ–≤–µ—Ä–Ω—ã–π –ø–∞—Ä–æ–ª—å –ø—Ä–æ–¥–∞–≤—Ü–∞');
    }
}

function renderSellerProducts() {
    const container = el('productsEditorList');
    if (!container) return;
    
    container.innerHTML = '';
    
    if (shopData.products.length === 0) {
        container.innerHTML = '<div class="muted">–¢–æ–≤–∞—Ä–æ–≤ –ø–æ–∫–∞ –Ω–µ—Ç</div>';
        return;
    }
    
    shopData.products.forEach(product => {
        const itemDiv = document.createElement('div');
        itemDiv.className = 'list-item';
        itemDiv.innerHTML = `
            <div style="flex:1">
                <b>${product.name}</b>
                <div class="muted">${product.price} ‚ÇΩ ‚Ä¢ ${getCatTitle(product.category)}</div>
            </div>
            <div style="display:flex;gap:6px">
                <button class="ghost" onclick="editProduct(${product.id})">‚úèÔ∏è</button>
                <button class="ghost" onclick="deleteProduct(${product.id})">‚ùå</button>
            </div>
        `;
        container.appendChild(itemDiv);
    });
}

async function createNewProduct() {
    const newProduct = {
        id: Date.now(),
        name: '–ù–æ–≤—ã–π —Ç–æ–≤–∞—Ä',
        price: 1000,
        category: 'weapon',
        subcategory: 'assault',
        img: 'https://picsum.photos/300/200?random=' + Date.now(),
        description: '–û–ø–∏—Å–∞–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞',
        caliber: '',
        attachments: {}
    };
    
    shopData.products.push(newProduct);
    await saveData(); // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ JSONBin
    renderSellerProducts();
    renderProducts();
    alert('–¢–æ–≤–∞—Ä —Å–æ–∑–¥–∞–Ω!');
}

async function deleteProduct(productId) {
    if (confirm('–£–¥–∞–ª–∏—Ç—å —Ç–æ–≤–∞—Ä?')) {
        shopData.products = shopData.products.filter(p => p.id !== productId);
        await saveData(); // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ JSONBin
        renderSellerProducts();
        renderProducts();
        alert('–¢–æ–≤–∞—Ä —É–¥–∞–ª–µ–Ω!');
    }
}

// üìù –†–ï–î–ê–ö–¢–û–† –ö–ê–¢–ï–ì–û–†–ò–ô
function renderCategoriesEditor() {
    renderMainCategories();
    renderSubCategories();
    renderAttachTypes();
}

function renderMainCategories() {
    const container = el('mainCategoriesList');
    if (!container) return;
    
    container.innerHTML = '';
    
    categories.mains.forEach(cat => {
        const itemDiv = document.createElement('div');
        itemDiv.className = 'list-item';
        itemDiv.innerHTML = `
            <div style="flex:1">${cat.title}</div>
            <button class="ghost" onclick="deleteMainCategory('${cat.id}')">‚ùå</button>
        `;
        container.appendChild(itemDiv);
    });
}

async function addMainCategory() {
    const name = el('newMainCat').value.trim();
    if (!name) {
        alert('–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏');
        return;
    }
    
    const id = name.toLowerCase().replace(/\s+/g, '_');
    
    if (categories.mains.find(c => c.id === id)) {
        alert('–ö–∞—Ç–µ–≥–æ—Ä–∏—è —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç');
        return;
    }
    
    categories.mains.push({ id, title: name });
    categories.subs[id] = [];
    el('newMainCat').value = '';
    
    renderCategoriesEditor();
    renderCategoryFilter();
    alert('–ö–∞—Ç–µ–≥–æ—Ä–∏—è –¥–æ–±–∞–≤–ª–µ–Ω–∞!');
}

async function deleteMainCategory(catId) {
    if (confirm('–£–¥–∞–ª–∏—Ç—å –∫–∞—Ç–µ–≥–æ—Ä–∏—é?')) {
        categories.mains = categories.mains.filter(c => c.id !== catId);
        delete categories.subs[catId];
        renderCategoriesEditor();
        renderCategoryFilter();
        renderProducts();
        alert('–ö–∞—Ç–µ–≥–æ—Ä–∏—è —É–¥–∞–ª–µ–Ω–∞!');
    }
}

function renderSubCategories() {
    const mainSelect = el('subForMain');
    const container = el('subCatsList');
    
    if (!mainSelect || !container) return;
    
    // –ó–∞–ø–æ–ª–Ω—è–µ–º –≤—ã–±–æ—Ä –æ—Å–Ω–æ–≤–Ω–æ–π –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
    mainSelect.innerHTML = '';
    categories.mains.forEach(cat => {
        const option = document.createElement('option');
        option.value = cat.id;
        option.textContent = cat.title;
        mainSelect.appendChild(option);
    });
    
    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–æ–¥–∫–∞—Ç–µ–≥–æ—Ä–∏–∏ –¥–ª—è –≤—ã–±—Ä–∞–Ω–Ω–æ–π –æ—Å–Ω–æ–≤–Ω–æ–π
    const selectedMain = mainSelect.value;
    container.innerHTML = '';
    
    if (categories.subs[selectedMain]) {
        categories.subs[selectedMain].forEach(sub => {
            const itemDiv = document.createElement('div');
            itemDiv.className = 'list-item';
            itemDiv.innerHTML = `
                <div style="flex:1">${sub.title}</div>
                <button class="ghost" onclick="deleteSubCategory('${selectedMain}', '${sub.id}')">‚ùå</button>
            `;
            container.appendChild(itemDiv);
        });
    }
}

async function addSubCategory() {
    const mainId = el('subForMain').value;
    const name = el('newSubCat').value.trim();
    
    if (!name) {
        alert('–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –ø–æ–¥–∫–∞—Ç–µ–≥–æ—Ä–∏–∏');
        return;
    }
    
    const id = name.toLowerCase().replace(/\s+/g, '_');
    
    if (!categories.subs[mainId]) {
        categories.subs[mainId] = [];
    }
    
    if (categories.subs[mainId].find(s => s.id === id)) {
        alert('–ü–æ–¥–∫–∞—Ç–µ–≥–æ—Ä–∏—è —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç');
        return;
    }
    
    categories.subs[mainId].push({ id, title: name });
    el('newSubCat').value = '';
    
    renderSubCategories();
    alert('–ü–æ–¥–∫–∞—Ç–µ–≥–æ—Ä–∏—è –¥–æ–±–∞–≤–ª–µ–Ω–∞!');
}

async function deleteSubCategory(mainId, subId) {
    if (confirm('–£–¥–∞–ª–∏—Ç—å –ø–æ–¥–∫–∞—Ç–µ–≥–æ—Ä–∏—é?')) {
        categories.subs[mainId] = categories.subs[mainId].filter(s => s.id !== subId);
        renderSubCategories();
        renderProducts();
        alert('–ü–æ–¥–∫–∞—Ç–µ–≥–æ—Ä–∏—è —É–¥–∞–ª–µ–Ω–∞!');
    }
}

function renderAttachTypes() {
    const container = el('attachTypesList');
    if (!container) return;
    
    container.innerHTML = '';
    
    categories.attachTypes.forEach((type, index) => {
        const itemDiv = document.createElement('div');
        itemDiv.className = 'list-item';
        itemDiv.innerHTML = `
            <div style="flex:1">${type}</div>
            <button class="ghost" onclick="deleteAttachType(${index})">‚ùå</button>
        `;
        container.appendChild(itemDiv);
    });
}

async function addAttachType() {
    const name = el('newAttachType').value.trim();
    if (!name) {
        alert('–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ —Ç–∏–ø–∞ –æ–±–≤–µ—Å–∞');
        return;
    }
    
    categories.attachTypes.push(name);
    el('newAttachType').value = '';
    
    renderAttachTypes();
    alert('–¢–∏–ø –æ–±–≤–µ—Å–∞ –¥–æ–±–∞–≤–ª–µ–Ω!');
}

async function deleteAttachType(index) {
    if (confirm('–£–¥–∞–ª–∏—Ç—å —Ç–∏–ø –æ–±–≤–µ—Å–∞?')) {
        categories.attachTypes.splice(index, 1);
        renderAttachTypes();
        alert('–¢–∏–ø –æ–±–≤–µ—Å–∞ —É–¥–∞–ª–µ–Ω!');
    }
}

// üöÄ –ó–ê–ü–£–°–ö –ü–†–ò–õ–û–ñ–ï–ù–ò–Ø
async function init() {
    console.log('–ó–∞–ø—É—Å–∫ –º–∞–≥–∞–∑–∏–Ω–∞...');
    
    // –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ –∏–∑ JSONBin
    await loadFromJSONBin();
    
    // –†–µ–Ω–¥–µ—Ä–∏–º –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å
    renderCategoryFilter();
    renderProducts();
    updateCartUI();
    
    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É "–ú–æ–∏ –∑–∞–∫–∞–∑—ã" –µ—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤–æ—à–µ–ª
    if (currentUser) {
        el('btnMyOrders').style.display = 'inline-block';
    }
    
    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –∫–Ω–æ–ø–æ–∫
    el('btnCart').onclick = () => togglePanel('cartPanel');
    el('btnLogin').onclick = () => togglePanel('loginPanel');
    el('btnSeller').onclick = () => togglePanel('sellerPanel');
    el('btnCheckout').onclick = checkout;
    el('btnSignIn').onclick = handleLogin;
    el('btnSellerLogin').onclick = handleSellerLogin;
    el('btnNewProduct').onclick = createNewProduct;
    
    // –ö–Ω–æ–ø–∫–∏ –∫–∞—Ç–µ–≥–æ—Ä–∏–π
    el('btnAddMainCat').onclick = addMainCategory;
    el('btnAddSubCat').onclick = addSubCategory;
    el('btnAddAttachType').onclick = addAttachType;
    
    // –ó–∞–∫—Ä—ã—Ç–∏–µ –ø–æ –∫–ª–∏–∫—É –Ω–∞ overlay
    el('overlay').onclick = closeAllPanels;
    
    console.log('‚úÖ –ú–∞–≥–∞–∑–∏–Ω –∑–∞–ø—É—â–µ–Ω!');
}

// üì± –ó–ê–ì–†–£–ó–ö–ê
document.addEventListener('DOMContentLoaded', init);

// üìù –í–†–ï–ú–ï–ù–ù–´–ï –§–£–ù–ö–¶–ò–ò (–¥–ª—è –¥–µ–º–æ)
function editProduct(id) {
    alert('–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞ ' + id + ' (–≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ)');
}

function openProductView(id) {
    alert('–ü—Ä–æ—Å–º–æ—Ç—Ä —Ç–æ–≤–∞—Ä–∞ ' + id + ' (–≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ)');
}</script>

</body>
</html>