<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>–ú–∞–≥–∞–∑–∏–Ω "100 –†–µ–Ω—Ç–≥–µ–Ω"</title>
<style>
  :root{
    --accent:#ff9800;
    --bg:#850000;
    --panel-bg:rgba(18,18,18,0.96);
    --muted:#9aa;
    --card:#101010;
    --glass: rgba(255,255,255,0.03);
  }
  *{box-sizing:border-box}
  html,body{height:100%;margin:0;font-family:Inter,system-ui,Arial,sans-serif;background:url('https://i.imgur.com/Z1OWJQa.png') center/cover fixed;color:#fff}
  a{color:inherit}
  button,input,select,textarea{font:inherit}
  button{cursor:pointer}

  header{display:flex;justify-content:space-between;align-items:flex-start;padding:12px 18px;background:linear-gradient(180deg,rgba(0,0,0,0.6),rgba(0,0,0,0.2));gap:12px;position:sticky;top:0;z-index:40}
  .brand{display:flex;flex-direction:column}
  .brand h1{margin:0;font-size:18px}
  .controls{display:flex;flex-direction:column;align-items:flex-end;gap:8px}
  .top-buttons{display:flex;gap:8px}

  .categoryFilter{display:flex;gap:8px;align-items:center;overflow:auto;max-width:720px;padding-bottom:6px}
  .categoryFilter button{background:transparent;border:1px solid var(--glass);padding:6px 10px;border-radius:8px;color:#fff}
  .categoryFilter button.active{background:var(--accent);color:#000}

  .subcategoryContainer{margin-top:8px}
  .subcategoryFilter{display:flex;gap:6px;flex-wrap:wrap;max-height:88px;overflow:auto;padding:6px}
  .subcategoryFilter button{background:transparent;border:1px solid var(--glass);padding:6px 8px;border-radius:6px;color:#fff;font-size:13px}
  .subcategoryFilter button.active{background:var(--accent);color:#000}

  .container{padding:18px;display:flex;gap:18px;flex-wrap:wrap;justify-content:flex-start}
  .product-list{display:flex;flex-wrap:wrap;gap:18px}
  .product{width:220px;background:var(--panel-bg);padding:10px;border-radius:10px;border:1px solid var(--glass);cursor:pointer;transition:transform .12s}
  .product:hover{transform:translateY(-6px)}
  .product img{width:100%;height:140px;object-fit:cover;border-radius:6px}
  .product h3{margin:8px 0 4px;font-size:15px}
  .product p{margin:2px 0;color:var(--muted);font-size:13px}

  .panel{position:fixed;right:14px;top:72px;width:520px;max-height:80vh;overflow:auto;background:var(--panel-bg);padding:12px;border-radius:10px;border:1px solid var(--glass);display:none;z-index:60}
  @media(max-width:980px){ .panel{left:14px;right:14px;width:auto} .product{width:calc(50% - 24px)} }

  .list-item{display:flex;justify-content:space-between;gap:8px;padding:8px;border-radius:8px;border:1px solid var(--glass);margin-top:8px;background:linear-gradient(180deg,#0c0c0c,#0a0a0a)}

  .overlay{position:fixed;inset:0;background:rgba(0,0,0,0.6);backdrop-filter:blur(3px);display:none;z-index:80}
  .modal{position:fixed;left:50%;top:50%;transform:translate(-50%,-50%);background:#0b0b0b;padding:16px;border-radius:10px;border:1px solid var(--glass);z-index:90;display:none;max-width:920px;width:92%;max-height:92vh;overflow:auto}
  .modal .close{position:absolute;right:10px;top:8px;background:transparent;border:1px solid var(--glass);color:#fff;padding:6px;border-radius:6px}
  .modal h2{margin:0 0 8px}

  .product-view{
    display:flex;
    gap:24px;
    align-items:flex-start;
    flex-wrap: wrap;
  }
  .product-view-left{
    min-width: 320px;
    flex: 1;
    display: flex;
    justify-content: center;
  }
  .product-view-left img{
    width: 100%;
    max-width: 400px;
    height: 350px;
    object-fit: contain;
    border-radius: 10px;
    background: var(--card);
    padding: 12px;
    border: 1px solid var(--glass);
  }
  .product-view-right{
    flex: 1;
    min-width: 300px;
  }
  .product-view-right h3{
    margin:0 0 12px;
    font-size: 20px;
  }
  .muted{
    color:var(--muted);
    font-size:14px;
  }

  .attach-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(150px,1fr));gap:10px;margin-top:8px}
  .attach-card{background:#0d0d0d;border:1px solid var(--glass);padding:8px;border-radius:8px;display:flex;flex-direction:column;align-items:center;text-align:center;transition:.12s}
  .attach-card img{width:90px;height:90px;object-fit:cover;border-radius:6px}
  .attach-card .title{margin-top:8px;font-size:13px}
  .attach-card .price{font-size:13px;color:var(--muted)}
  .attach-card .row{margin-top:8px;display:flex;align-items:center;gap:6px}
  .attach-card.selected{border:2px solid var(--accent);background:linear-gradient(180deg, rgba(26,18,0,0.15), rgba(0,0,0,0.05))}

  .form-row{display:flex;gap:8px;flex-wrap:wrap}
  .form-col{flex:1;min-width:160px}
  input,select,textarea{width:100%;padding:8px;border-radius:8px;border:1px solid #222;background:#080808;color:#fff}
  textarea{min-height:80px}

  .btn{background:var(--accent);color:#000;padding:8px;border-radius:8px;border:none}
  .ghost{background:transparent;border:1px solid var(--glass);color:#fff;padding:6px;border-radius:6px}

  .small-muted{font-size:12px;color:var(--muted);margin-top:6px}
  .attach-row{display:flex;gap:8px;align-items:center;margin-top:8px}
  .attach-row input[type="text"], .attach-row input[type="number"], .attach-row select{padding:6px;border-radius:6px;background:#080808;border:1px solid #222;color:#fff}
  .msg-box{margin-top:8px;display:flex;gap:8px}
  .chat-note{margin-top:6px;font-size:13px;color:#ffdca8}
</style>
</head>
<body>

<header>
  <div class="brand">
    <h1>100 –†–µ–Ω—Ç–≥–µ–Ω ‚Äî –≤–Ω—É—Ç—Ä–∏–∏–≥—Ä–æ–≤–æ–π –º–∞–≥–∞–∑–∏–Ω</h1>
    <div class="muted">–ú–∏–Ω–∏–º–∞–ª–∏—Å—Ç–∏—á–Ω—ã–π –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å ‚Äî —Ä–∞–±–æ—á–∞—è –≤–µ—Ä—Å–∏—è</div>
  </div>

  <div class="controls">
    <div class="top-buttons">
      <button id="btnCart" class="ghost">–ö–æ—Ä–∑–∏–Ω–∞</button>
      <button id="btnLogin" class="ghost">–í—Ö–æ–¥</button>
      <button id="btnMyOrders" class="ghost" style="display:none">–ú–æ–∏ –∑–∞—è–≤–∫–∏</button>
      <button id="btnSeller" class="ghost">–ü–∞–Ω–µ–ª—å –ø—Ä–æ–¥–∞–≤—Ü–∞</button>
    </div>

    <div class="categoryFilter" id="categoryFilter"></div>
    <div class="subcategoryContainer" id="subcategoryContainer"></div>
  </div>
</header>

<main class="container">
  <div id="productList" class="product-list"></div>
</main>

<div id="overlay" class="overlay"></div>

<div id="productModalView" class="modal" aria-hidden="true">
  <button class="close" id="closeProductView">‚úï</button>
  <div id="productViewContent"></div>
</div>

<div id="productModalEdit" class="modal" aria-hidden="true">
  <button class="close" id="closeProductEdit">‚úï</button>
  <h2 id="editTitle">–î–æ–±–∞–≤–∏—Ç—å / –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —Ç–æ–≤–∞—Ä</h2>
  <div id="productEditForm"></div>
</div>

<div id="cartPanel" class="panel">
  <h3>–ö–æ—Ä–∑–∏–Ω–∞</h3>
  <div id="cartItems"></div>
  <p>–ò—Ç–æ–≥–æ: <b id="cartTotal">0</b> üí∞</p>
  <div style="display:flex;gap:8px;justify-content:flex-end">
    <button id="btnCheckout" class="btn">–û—Ñ–æ—Ä–º–∏—Ç—å –∑–∞—è–≤–∫—É</button>
  </div>
</div>

<div id="loginPanel" class="panel">
  <h3>–í—Ö–æ–¥ / –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</h3>
  <input id="username" placeholder="–ò–º—è" />
  <input id="password" placeholder="–ü–∞—Ä–æ–ª—å" type="password" />
  <div style="display:flex;gap:8px;margin-top:8px">
    <button id="btnRegister" class="btn">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</button>
    <button id="btnSignIn" class="btn">–í–æ–π—Ç–∏</button>
  </div>
</div>

<div id="myOrdersPanel" class="panel">
  <h3>–ú–æ–∏ –∑–∞—è–≤–∫–∏</h3>
  <div id="myOrdersList"></div>
</div>

<div id="sellerPanel" class="panel">
  <h3>–ü–∞–Ω–µ–ª—å –ø—Ä–æ–¥–∞–≤—Ü–∞</h3>
  <div id="sellerLoginArea">
    <input id="sellerPass" placeholder="–ü–∞—Ä–æ–ª—å –ø—Ä–æ–¥–∞–≤—Ü–∞" type="password" />
    <div style="display:flex;gap:8px;margin-top:8px">
      <button id="btnSellerLogin" class="btn">–í–æ–π—Ç–∏</button>
      <button id="btnSellerCancel" class="ghost">–ó–∞–∫—Ä—ã—Ç—å</button>
    </div>
  </div>

  <div id="sellerArea" style="display:none;margin-top:12px">
    <div style="display:flex;gap:8px;margin-bottom:8px">
      <button id="tabOrders" class="ghost">–ó–∞—è–≤–∫–∏</button>
      <button id="tabProducts" class="ghost">–¢–æ–≤–∞—Ä—ã</button>
      <button id="tabCategories" class="ghost">–ö–∞—Ç–µ–≥–æ—Ä–∏–∏</button>
      <button id="btnSellerLogout" class="ghost" style="margin-left:auto">–í—ã–π—Ç–∏</button>
    </div>

    <div id="sellerOrdersSection">
      <div id="ordersList"></div>
    </div>

    <div id="sellerProductsSection" style="display:none">
      <div id="productsEditorList"></div>
      <div style="margin-top:12px">
        <button id="btnNewProduct" class="btn">‚ûï –î–æ–±–∞–≤–∏—Ç—å —Ç–æ–≤–∞—Ä</button>
      </div>
    </div>

    <div id="sellerCategoriesSection" style="display:none">
      <div style="margin-top:6px">
        <strong>–û—Å–Ω–æ–≤–Ω—ã–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏</strong>
        <div id="mainCategoriesList"></div>
        <div style="display:flex;gap:8px;margin-top:8px">
          <input id="newMainCat" placeholder="–î–æ–±–∞–≤–∏—Ç—å –∫–∞—Ç–µ–≥–æ—Ä–∏—é" />
          <button id="btnAddMainCat" class="btn">–î–æ–±–∞–≤–∏—Ç—å</button>
        </div>
      </div>

      <div style="margin-top:12px">
        <strong>–ü–æ–¥–∫–∞—Ç–µ–≥–æ—Ä–∏–∏ (–≤—ã–±–µ—Ä–∏—Ç–µ –æ—Å–Ω–æ–≤–Ω—É—é)</strong>
        <select id="subForMain"></select>
        <div id="subCatsList" style="margin-top:8px;max-height:180px;overflow:auto"></div>
        <div style="display:flex;gap:8px;margin-top:8px">
          <input id="newSubCat" placeholder="–î–æ–±–∞–≤–∏—Ç—å –ø–æ–¥–∫–∞—Ç–µ–≥–æ—Ä–∏—é" />
          <button id="btnAddSubCat" class="btn">–î–æ–±–∞–≤–∏—Ç—å</button>
        </div>
      </div>

      <div style="margin-top:12px">
        <strong>–¢–∏–ø—ã –æ–±–≤–µ—Å–æ–≤</strong>
        <div id="attachTypesList"></div>
        <div style="display:flex;gap:8px;margin-top:8px">
          <input id="newAttachType" placeholder="–î–æ–±–∞–≤–∏—Ç—å —Ç–∏–ø –æ–±–≤–µ—Å–∞" />
          <button id="btnAddAttachType" class="btn">–î–æ–±–∞–≤–∏—Ç—å</button>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
/* -------------------------
   JSONBin Configuration
   ------------------------- */
const JSONBIN_BASE_URL = 'https://api.jsonbin.io/v3/b';
const JSONBIN_MASTER_KEY = '$2a$10$wTicXNpl/tYWk2p1tuUuC.w87l4en0x8a9e7STVUKFIfFQnaZFdLC'; // –ó–∞–º–µ–Ω–∏—Ç–µ –Ω–∞ –≤–∞—à –º–∞—Å—Ç–µ—Ä-–∫–ª—é—á
const JSONBIN_ACCESS_KEY = '$2a$10$.twuYFU3QYQ1ZXPY.uyfB.7EryqBOUndWb3UbhjCfknwxJvHKo2LG'; // –ó–∞–º–µ–Ω–∏—Ç–µ –Ω–∞ –≤–∞—à access –∫–ª—é—á

// ID –≤–∞—à–∏—Ö bin'–æ–≤ –Ω–∞ JSONBin
const JSONBIN_IDS = {
  PRODUCTS: '6904f4cbae596e708f3ab82d',
  USERS: '6904f5d843b1c97be98eff3a', 
  CATS: '6904f52243b1c97be98efe37',
  CHATS: '6904f602ae596e708f3aba24'
};

/* -------------------------
   Storage & defaults
   ------------------------- */
const KEY_PRODUCTS = 'products_v_final_v1';
const KEY_USERS = 'users_v_final_v1';
const KEY_CATS = 'cats_v_final_v1';
const KEY_SELLER = 'isSeller_v1';
const KEY_CHATS = 'chats_v1';

const DEFAULT_CATS = {
  mains: [
    {id:'weapon', title:'–û—Ä—É–∂–∏–µ'},
    {id:'armor', title:'–ë—Ä–æ–Ω—è'},
    {id:'attachments', title:'–û–±–≤–µ—Å—ã'},
    {id:'consumable', title:'–†–∞—Å—Ö–æ–¥–Ω–∏–∫–∏'}
  ],
  subs: {
    weapon: [
      {id:'sniper', title:'–°–Ω–∞–π–ø–µ—Ä—Å–∫–∏–µ'},
      {id:'assault', title:'–®—Ç—É—Ä–º–æ–≤—ã–µ'},
      {id:'smg', title:'–ü–ü'},
      {id:'pistol', title:'–ü–∏—Å—Ç–æ–ª–µ—Ç—ã'}
    ],
    armor: [
      {id:'body', title:'–ë—Ä–æ–Ω—è'},
      {id:'helmet', title:'–®–ª–µ–º—ã'}
    ],
    attachments:[
      {id:'sight', title:'–ü—Ä–∏—Ü–µ–ª—ã'},
      {id:'grip', title:'–†—É—á–∫–∏'},
      {id:'stock', title:'–ü—Ä–∏–∫–ª–∞–¥—ã'}
    ]
  },
  attachTypes: ['–ü—Ä–∏—Ü–µ–ª—ã','–†—É—á–∫–∏','–ü—Ä–∏–∫–ª–∞–¥—ã','–¶–µ–≤—å—è','–ú–∞–≥–∞–∑–∏–Ω']
};

const DEFAULT_PRODUCTS = [
  { id:1, name:'–ü–∏—Å—Ç–æ–ª–µ—Ç –ü–ú', price:120, img:'https://i.imgur.com/7bHnZ0f.png', category:'weapon', subcategory:'pistol', caliber:'9x18mm', description:'–ù–∞–¥—ë–∂–Ω—ã–π –ø–∏—Å—Ç–æ–ª–µ—Ç –±–ª–∏–∂–Ω–µ–≥–æ –±–æ—è.', attachments: { '–ü—Ä–∏—Ü–µ–ª—ã': [{name:'–ö–æ–ª–ª–∏–º–∞—Ç–æ—Ä', price:60, img:'https://i.imgur.com/y1svLkP.png'}] } },
  { id:2, name:'–í–∏–Ω—Ç–æ–≤–∫–∞ –ê–ö', price:420, img:'https://i.imgur.com/t2G6M0l.png', category:'weapon', subcategory:'assault', caliber:'7.62x39mm', description:'–ö–ª–∞—Å—Å–∏—á–µ—Å–∫–∞—è —à—Ç—É—Ä–º–æ–≤–∞—è –≤–∏–Ω—Ç–æ–≤–∫–∞.', attachments: { '–ü—Ä–∏—Ü–µ–ª—ã': [{name:'–û–ø—Ç–∏–∫–∞ 4x', price:200, img:'https://i.imgur.com/I4bZpPZ.png'}], '–ü—Ä–∏–∫–ª–∞–¥—ã': [{name:'–°–∫–ª–∞–¥–Ω–æ–π –ø—Ä–∏–∫–ª–∞–¥', price:150, img:'https://i.imgur.com/1YhTVEr.png'}] } },
  { id:3, name:'–ö–æ–º–±–∏–Ω–µ–∑–æ–Ω', price:300, img:'https://i.imgur.com/Q9P6S0R.png', category:'armor', subcategory:'body', caliber:'', description:'–ó–∞—â–∏—Ç–Ω—ã–π –∫–æ–º–±–µ–∑ –¥–ª—è —Ä–µ–π–¥–æ–≤.', attachments: {} }
];

let products = [];
let cats = {};
let users = {};
let currentUser = null;
let cart = [];
const sellerPassword = 'admin123';
let selectedCategory = 'all';
let selectedSubcategory = null;

/* -------------------------
   JSONBin Helpers
   ------------------------- */
async function jsonbinFetch(binId, options = {}) {
  const url = `${JSONBIN_BASE_URL}/${binId}`;
  const headers = {
    'Content-Type': 'application/json',
    'X-Master-Key': JSONBIN_MASTER_KEY,
    'X-Access-Key': JSONBIN_ACCESS_KEY,
    ...options.headers
  };
  
  try {
    const response = await fetch(url, { ...options, headers });
    if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
    const data = await response.json();
    return data.record;
  } catch (error) {
    console.error('JSONBin error:', error);
    return null;
  }
}

async function jsonbinUpdate(binId, data) {
  return await jsonbinFetch(binId, {
    method: 'PUT',
    body: JSON.stringify(data)
  });
}

async function loadJSON(key, fallback) {
  try {
    let binId;
    switch(key) {
      case KEY_PRODUCTS: binId = JSONBIN_IDS.PRODUCTS; break;
      case KEY_USERS: binId = JSONBIN_IDS.USERS; break;
      case KEY_CATS: binId = JSONBIN_IDS.CATS; break;
      case KEY_CHATS: binId = JSONBIN_IDS.CHATS; break;
      default: return JSON.parse(JSON.stringify(fallback));
    }
    
    const data = await jsonbinFetch(binId);
    return data || JSON.parse(JSON.stringify(fallback));
  } catch(e) {
    console.error('Load error:', e);
    return JSON.parse(JSON.stringify(fallback));
  }
}

async function saveJSON(key, val) {
  try {
    let binId;
    switch(key) {
      case KEY_PRODUCTS: binId = JSONBIN_IDS.PRODUCTS; break;
      case KEY_USERS: binId = JSONBIN_IDS.USERS; break;
      case KEY_CATS: binId = JSONBIN_IDS.CATS; break;
      case KEY_CHATS: binId = JSONBIN_IDS.CHATS; break;
      default: return;
    }
    
    await jsonbinUpdate(binId, val);
    return true;
  } catch(e) {
    console.error('Save error:', e);
    return false;
  }
}

const el = id => document.getElementById(id);

/* Chat helpers */
function chatKey(user, orderIndex){ return `${user}|${orderIndex}`; }
async function loadChats(){ return await loadJSON(KEY_CHATS, {}); }
async function saveChats(obj){ return await saveJSON(KEY_CHATS, obj); }
async function loadChat(user, orderIndex){ const all = await loadChats(); return all[chatKey(user,orderIndex)] || ''; }
async function saveChat(user, orderIndex, msg){ const all = await loadChats(); all[chatKey(user,orderIndex)] = msg; return await saveChats(all); }

/* -------------------------
   Data Initialization
   ------------------------- */
async function initializeData() {
  try {
    [products, users, cats] = await Promise.all([
      loadJSON(KEY_PRODUCTS, DEFAULT_PRODUCTS),
      loadJSON(KEY_USERS, {}),
      loadJSON(KEY_CATS, DEFAULT_CATS)
    ]);
  } catch (error) {
    console.error('Data initialization failed:', error);
    // Fallback to defaults
    products = JSON.parse(JSON.stringify(DEFAULT_PRODUCTS));
    users = {};
    cats = JSON.parse(JSON.stringify(DEFAULT_CATS));
  }
}

/* -------------------------
   Panels toggling (close others)
   ------------------------- */
function closeAllPanels(){
  ['cartPanel','loginPanel','myOrdersPanel','sellerPanel'].forEach(id=>{ const e=el(id); if(e) e.style.display='none'; });
  hideModal('productModalView'); hideModal('productModalEdit'); document.getElementById('overlay').style.display='none';
}
function togglePanel(panelId){
  // close others
  ['cartPanel','loginPanel','myOrdersPanel','sellerPanel'].forEach(id=>{ if(id!==panelId) el(id).style.display='none'; });
  const p = el(panelId);
  p.style.display = (p.style.display === 'block') ? 'none' : 'block';
  hideModal('productModalView'); hideModal('productModalEdit');
  document.getElementById('overlay').style.display='none';
}

/* Attach top buttons */
el('btnCart').addEventListener('click', ()=> togglePanel('cartPanel'));
el('btnLogin').addEventListener('click', ()=> togglePanel('loginPanel'));
el('btnMyOrders').addEventListener('click', ()=> { renderMyOrders(); togglePanel('myOrdersPanel'); });
el('btnSeller').addEventListener('click', ()=> togglePanel('sellerPanel'));

/* -------------------------
   Category rendering
   ------------------------- */
function slug(s){ return String(s||'').toLowerCase().replace(/\s+/g,'_').replace(/[^a-z0-9_]/gi,''); }

function renderCategoryFilter(){
  const wrap = el('categoryFilter'); wrap.innerHTML='';
  const all = document.createElement('button'); all.textContent='–í—Å–µ'; if(selectedCategory==='all') all.classList.add('active');
  all.onclick = ()=>{ selectedCategory='all'; selectedSubcategory=null; renderCategoryFilter(); renderSubcats(null); renderProducts(); };
  wrap.appendChild(all);
  cats.mains.forEach(m=>{
    const b = document.createElement('button'); b.textContent = m.title;
    if(selectedCategory===m.id) b.classList.add('active');
    b.onclick = ()=>{ selectedCategory=m.id; selectedSubcategory=null; renderCategoryFilter(); renderSubcats(m.id); renderProducts(); };
    wrap.appendChild(b);
  });
}
function renderSubcats(mainId){
  const container = el('subcategoryContainer'); container.innerHTML='';
  if(!mainId || !cats.subs[mainId] || !cats.subs[mainId].length) return;
  const wrap = document.createElement('div'); wrap.className='subcategoryFilter';
  const bAll = document.createElement('button'); bAll.textContent='–í—Å–µ –ø–æ–¥–∫–∞—Ç–µ–≥–æ—Ä–∏–∏';
  bAll.onclick = ()=>{ selectedSubcategory=null; Array.from(wrap.querySelectorAll('button')).forEach(x=>x.classList.remove('active')); bAll.classList.add('active'); renderProducts(); };
  wrap.appendChild(bAll);
  cats.subs[mainId].forEach(sc=>{
    const b = document.createElement('button'); b.textContent = sc.title;
    b.onclick = ()=>{ selectedSubcategory = sc.id; Array.from(wrap.querySelectorAll('button')).forEach(x=>x.classList.remove('active')); b.classList.add('active'); renderProducts(); };
    wrap.appendChild(b);
  });
  container.appendChild(wrap);
}

/* -------------------------
   Products render
   ------------------------- */
function renderProducts(){
  const list = el('productList'); list.innerHTML='';
  products.filter(p=>{
    if(selectedCategory!=='all' && p.category !== selectedCategory) return false;
    if(selectedSubcategory && p.subcategory && p.subcategory !== selectedSubcategory) return false;
    return true;
  }).forEach(p=>{
    const d = document.createElement('div'); d.className='product'; d.dataset.id = p.id;
    d.innerHTML = `<img src="${p.img||''}" alt="${escapeHtml(p.name)}"><h3>${escapeHtml(p.name)}</h3><p class="muted">${p.caliber?p.caliber+' ‚Ä¢ ':''}${getCatTitle(p.category)} ${p.subcategory?'/ '+getSubTitle(p.category,p.subcategory):''}</p><p><b>${p.price} üí∞</b></p>`;
    d.addEventListener('click', ()=> openProductView(p.id));
    list.appendChild(d);
  });
}

/* -------------------------
   Product view modal (attachments selection + total)
   ------------------------- */
function openProductView(prodId){
  const p = products.find(x=>x.id===prodId); if(!p) return;
  const wrap = el('productViewContent'); wrap.innerHTML='';
  const content = document.createElement('div'); content.className='product-view';
  const left = document.createElement('div'); left.className='product-view-left'; left.innerHTML=`<img src="${p.img||''}" alt="${escapeHtml(p.name)}">`;
  const right = document.createElement('div'); right.className='product-view-right';
  right.innerHTML = `<h3>${escapeHtml(p.name)}</h3><p class="muted">–ö–∞—Ç–µ–≥–æ—Ä–∏—è: ${getCatTitle(p.category)} ${p.subcategory?'/ '+getSubTitle(p.category,p.subcategory):''}</p><p class="muted">–ö–∞–ª–∏–±—Ä: ${p.caliber||'‚Äî'}</p><p style="margin-top:8px">${escapeHtml(p.description||'')}</p><p style="margin-top:8px"><b>–ë–∞–∑–∞: ${p.price} üí∞</b></p><div id="pv_attach_area"></div><div style="margin-top:8px" class="total-line">–ò—Ç–æ–≥–æ: <b id="pv_build_total">${p.price}</b> üí∞</div><div style="display:flex;gap:8px;margin-top:12px;justify-content:flex-end"><button id="pv_add_to_cart" class="btn">–î–æ–±–∞–≤–∏—Ç—å –≤ –∫–æ—Ä–∑–∏–Ω—É</button><button id="pv_close" class="ghost">–ó–∞–∫—Ä—ã—Ç—å</button></div>`;
  content.appendChild(left); content.appendChild(right); wrap.appendChild(content);

  // attachments grid
  const attachArea = el('pv_attach_area'); attachArea.innerHTML='<strong>–û–±–≤–µ—Å—ã:</strong>';
  const grid = document.createElement('div'); grid.className='attach-grid';
  const attachTypes = Object.keys(p.attachments || {});
  const chosen = []; // {type,name,price,img,quantity}
  
  function updateTotalAndHighlight(){
    // –£—á–∏—Ç—ã–≤–∞–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ
    const extra = chosen.reduce((s,a)=>s + (a.price * (a.quantity || 1)), 0);
    el('pv_build_total').textContent = p.price + extra;
    
    // highlight
    grid.querySelectorAll('.attach-card').forEach(card=>{
      const t = card.dataset.type, n = card.dataset.name;
      const chosenItem = chosen.find(c=>c.type===t && c.name===n);
      
      if(chosenItem) {
        card.classList.add('selected');
        // –î–ª—è –∫–æ–ª–∏—á–µ—Å—Ç–≤–µ–Ω–Ω—ã—Ö –æ–±–≤–µ—Å–æ–≤ –æ–±–Ω–æ–≤–ª—è–µ–º –∑–Ω–∞—á–µ–Ω–∏–µ –≤ —Å–µ–ª–µ–∫—Ç–æ—Ä–µ
        const select = card.querySelector('.quantity-select');
        if(select) select.value = chosenItem.quantity || 0;
        // –î–ª—è –æ–±—ã—á–Ω—ã—Ö –æ–±–≤–µ—Å–æ–≤ –æ–±–Ω–æ–≤–ª—è–µ–º —á–µ–∫–±–æ–∫—Å
        const checkbox = card.querySelector('input[type=checkbox]');
        if(checkbox) checkbox.checked = true;
      } else {
        card.classList.remove('selected');
        const select = card.querySelector('.quantity-select');
        if(select) select.value = 0;
        const checkbox = card.querySelector('input[type=checkbox]');
        if(checkbox) checkbox.checked = false;
      }
    });
  }
  
  if(attachTypes.length===0) grid.innerHTML = '<div class="muted" style="padding:8px">–ù–µ—Ç –æ–±–≤–µ—Å–æ–≤</div>';
  else {
    attachTypes.forEach(type=>{
      (p.attachments[type]||[]).forEach(opt=>{
        const card = document.createElement('div'); 
        card.className='attach-card';
        card.dataset.type = type; 
        card.dataset.name = opt.name;
        
        if(opt.quantity) {
          // –î–õ–Ø –ö–û–õ–ò–ß–ï–°–¢–í–ï–ù–ù–´–• - —Å–µ–ª–µ–∫—Ç–æ—Ä
          card.innerHTML = `
            <img src="${opt.img||''}" alt="${escapeHtml(opt.name)}">
            <div class="title">${escapeHtml(opt.name)}</div>
            <div class="price">${opt.price} üí∞/—à—Ç</div>
            <div class="row">
              <select class="quantity-select" style="background:#080808;color:#fff;border:1px solid #333;border-radius:4px;padding:2px">
                <option value="0">0</option>
                <option value="1">1</option>
                <option value="2">2</option>
                <option value="3">3</option>
                <option value="4">4</option>
                <option value="5">5</option>
                <option value="6">6</option>
                <option value="7">7</option>
                <option value="8">8</option>
                <option value="9">9</option>
                <option value="10">10</option>
              </select>
            </div>
          `;
          
          // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è –∫–æ–ª–∏—á–µ—Å—Ç–≤–µ–Ω–Ω—ã—Ö –æ–±–≤–µ—Å–æ–≤
          const select = card.querySelector('.quantity-select');
          select.addEventListener('change', ()=>{
            const qty = parseInt(select.value);
            const existingIdx = chosen.findIndex(x=>x.type===type && x.name===opt.name);
            
            if(qty === 0 && existingIdx >= 0) {
              chosen.splice(existingIdx, 1);
            } else if(qty > 0) {
              if(existingIdx >= 0) {
                chosen[existingIdx].quantity = qty;
              } else {
                chosen.push({ 
                  type, 
                  name: opt.name, 
                  price: opt.price, 
                  img: opt.img,
                  quantity: qty 
                });
              }
            }
            updateTotalAndHighlight();
          });
        } else {
          // –î–õ–Ø –û–ë–´–ß–ù–´–• - —á–µ–∫–±–æ–∫—Å
          card.innerHTML = `
            <img src="${opt.img||''}" alt="${escapeHtml(opt.name)}">
            <div class="title">${escapeHtml(opt.name)}</div>
            <div class="price">${opt.price} üí∞</div>
            <div class="row"><label><input type="checkbox"></label></div>
          `;
          
          // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è –æ–±—ã—á–Ω—ã—Ö –æ–±–≤–µ—Å–æ–≤
          card.addEventListener('click', (ev)=>{
            const cb = card.querySelector('input[type=checkbox]');
            cb.checked = !cb.checked;
            if(cb.checked) {
              chosen.push({type, name: opt.name, price: opt.price, img: opt.img, quantity: 1});
            } else {
              const idx = chosen.findIndex(x=>x.type===type && x.name===opt.name);
              if(idx>=0) chosen.splice(idx,1);
            }
            updateTotalAndHighlight();
          });
        }
        grid.appendChild(card);
      });
    });
  }
  attachArea.appendChild(grid);
  updateTotalAndHighlight();

  // add to cart
  el('pv_add_to_cart').onclick = ()=>{
    if(!currentUser){ alert('–í–æ–π–¥–∏—Ç–µ –¥–ª—è –ø–æ–∫—É–ø–∫–∏'); return; }
    cart.push({ 
      id:p.id, 
      name:p.name, 
      price:p.price, 
      qty:1, 
      attachments: chosen.map(x=>({
        type: x.type,
        name: x.name, 
        price: x.price, 
        img: x.img,
        quantity: x.quantity || 1
      })) 
    });
    updateCartUI(); 
    hideModal('productModalView'); 
    alert('–¢–æ–≤–∞—Ä –¥–æ–±–∞–≤–ª–µ–Ω –≤ –∫–æ—Ä–∑–∏–Ω—É');
  };
  el('pv_close').onclick = ()=> hideModal('productModalView');

  showModal('productModalView');
}

/* -------------------------
   Modal helpers
   ------------------------- */
function showModal(id){ document.getElementById('overlay').style.display='block'; el(id).style.display='block'; }
function hideModal(id){ if(el(id)) el(id).style.display='none'; document.getElementById('overlay').style.display='none'; }
el('closeProductView').addEventListener('click', ()=> hideModal('productModalView'));
el('closeProductEdit').addEventListener('click', ()=> hideModal('productModalEdit'));

/* -------------------------
   Cart UI
   ------------------------- */
function updateCartUI(){
  const box = el('cartItems'); box.innerHTML=''; let total=0;
  cart.forEach((it, idx)=>{
    const row = document.createElement('div'); row.className='list-item';
    const left = document.createElement('div'); 
    let attachText = '';
    if(it.attachments && it.attachments.length) {
      attachText = it.attachments.map(a => {
        if(a.quantity > 1) {
          return `${a.name} √ó${a.quantity} (${a.price * a.quantity}üí∞)`;
        } else {
          return `${a.name} (${a.price}üí∞)`;
        }
      }).join(', ');
    }
    left.innerHTML = `<div><b>${escapeHtml(it.name)}</b></div><div class="muted">${attachText}</div>`;
    const right = document.createElement('div'); right.innerHTML = `<div>${it.price} üí∞ √ó <input type="number" value="${it.qty}" min="1" style="width:60px" data-idx="${idx}"></div><div style="margin-top:6px"><button data-rem="${idx}" class="ghost">‚ùå</button></div>`;
    row.appendChild(left); row.appendChild(right); box.appendChild(row);
    // –£—á–∏—Ç—ã–≤–∞–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –≤ –æ–±–≤–µ—Å–∞—Ö
    total += it.price * (it.qty||1) + (it.attachments? it.attachments.reduce((s,a)=>s + (a.price * (a.quantity || 1)),0):0);
  });
  el('cartTotal').textContent = total;
  box.querySelectorAll('input[type=number]').forEach(inp=> inp.addEventListener('change', e=>{ const i = parseInt(e.target.dataset.idx); cart[i].qty = Math.max(1, parseInt(e.target.value)||1); updateCartUI(); }));
  box.querySelectorAll('button[data-rem]').forEach(btn=> btn.addEventListener('click', ()=>{ cart.splice(parseInt(btn.dataset.rem),1); updateCartUI(); }));
}

el('btnCheckout').addEventListener('click', async ()=> {
  if(!currentUser){ alert('–í–æ–π–¥–∏—Ç–µ'); return; }
  if(cart.length===0) return alert('–ö–æ—Ä–∑–∏–Ω–∞ –ø—É—Å—Ç–∞');
  users = await loadJSON(KEY_USERS, users);
  users[currentUser] = users[currentUser] || { password:'', orders:[] };
  users[currentUser].orders = users[currentUser].orders || [];
  users[currentUser].orders.push({ 
    id: Date.now(), 
    date: new Date().toLocaleString(), 
    items: JSON.parse(JSON.stringify(cart)), 
    status: 'pending',
    total: cart.reduce((s,it)=>s + it.price * (it.qty||1) + (it.attachments? it.attachments.reduce((sa,a)=>sa + (a.price * (a.quantity || 1)),0):0),0)
  });
  const saved = await saveJSON(KEY_USERS, users);
  if(saved) {
    alert('–ó–∞—è–≤–∫–∞ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞');
    cart = []; updateCartUI(); togglePanel('cartPanel');
  } else {
    alert('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –∑–∞—è–≤–∫–∏');
  }
});

/* -------------------------
   Login / Register
   ------------------------- */
el('btnRegister').addEventListener('click', async ()=>{
  const u = el('username').value.trim(), p = el('password').value.trim();
  if(!u || !p) return alert('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –ø–æ–ª—è');
  users = await loadJSON(KEY_USERS, users);
  if(users[u]) return alert('–ò–º—è –∑–∞–Ω—è—Ç–æ');
  users[u] = { password: p, orders: [] };
  const saved = await saveJSON(KEY_USERS, users);
  if(saved) { alert('–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è —É—Å–ø–µ—à–Ω–∞'); currentUser = u; updateUserUI(); togglePanel('loginPanel'); } 
  else alert('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è');
});
el('btnSignIn').addEventListener('click', async ()=>{
  const u = el('username').value.trim(), p = el('password').value.trim();
  if(!u || !p) return alert('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –ø–æ–ª—è');
  users = await loadJSON(KEY_USERS, users);
  if(users[u] && users[u].password === p){ currentUser = u; updateUserUI(); togglePanel('loginPanel'); }
  else alert('–ù–µ–≤–µ—Ä–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ');
});

function updateUserUI(){
  el('btnLogin').style.display = currentUser ? 'none' : 'block';
  el('btnMyOrders').style.display = currentUser ? 'block' : 'none';
}

/* -------------------------
   My Orders
   ------------------------- */
async function renderMyOrders(){
  const list = el('myOrdersList'); list.innerHTML='';
  if(!currentUser) return;
  users = await loadJSON(KEY_USERS, users);
  const user = users[currentUser];
  if(!user || !user.orders || !user.orders.length) return list.innerHTML='<div class="muted">–ù–µ—Ç –∑–∞—è–≤–æ–∫</div>';
  user.orders.forEach((o,idx)=>{
    const d = document.createElement('div'); d.className='list-item';
    d.innerHTML = `<div><b>–ó–∞—è–≤–∫–∞ #${o.id}</b><div class="muted">${o.date}</div><div class="muted">${o.items.length} —Ç–æ–≤–∞—Ä–æ–≤</div></div><div><b>${o.total} üí∞</b><div class="muted">${o.status}</div></div>`;
    list.appendChild(d);
  });
}

/* -------------------------
   Seller Panel
   ------------------------- */
el('btnSellerLogin').addEventListener('click', ()=>{
  const pass = el('sellerPass').value;
  if(pass === sellerPassword){
    el('sellerLoginArea').style.display='none';
    el('sellerArea').style.display='block';
    renderSellerOrders();
    renderSellerProducts();
    renderSellerCategories();
  } else alert('–ù–µ–≤–µ—Ä–Ω—ã–π –ø–∞—Ä–æ–ª—å');
});
el('btnSellerCancel').addEventListener('click', ()=> togglePanel('sellerPanel'));

el('tabOrders').addEventListener('click', ()=> { showSection('sellerOrdersSection'); });
el('tabProducts').addEventListener('click', ()=> { showSection('sellerProductsSection'); renderSellerProducts(); });
el('tabCategories').addEventListener('click', ()=> { showSection('sellerCategoriesSection'); renderSellerCategories(); });
function showSection(id){ ['sellerOrdersSection','sellerProductsSection','sellerCategoriesSection'].forEach(s=>el(s).style.display='none'); el(id).style.display='block'; }
el('btnSellerLogout').addEventListener('click', ()=>{ el('sellerLoginArea').style.display='block'; el('sellerArea').style.display='none'; });

/* Seller Orders */
async function renderSellerOrders(){
  const list = el('ordersList'); list.innerHTML='';
  users = await loadJSON(KEY_USERS, users);
  const allOrders = [];
  Object.keys(users).forEach(u=>{
    if(users[u].orders) users[u].orders.forEach(o=> allOrders.push({...o, user:u}));
  });
  allOrders.sort((a,b)=>b.id - a.id);
  if(allOrders.length===0) return list.innerHTML='<div class="muted">–ù–µ—Ç –∑–∞—è–≤–æ–∫</div>';
  allOrders.forEach(o=>{
    const d = document.createElement('div'); d.className='list-item';
    d.innerHTML = `<div><b>${escapeHtml(o.user)}</b><div class="muted">${o.date}</div><div class="muted">${o.items.length} —Ç–æ–≤–∞—Ä–æ–≤</div></div><div><b>${o.total} üí∞</b><div class="muted">${o.status}</div><div style="margin-top:6px"><button class="ghost" data-user="${o.user}" data-id="${o.id}">–ß–∞—Ç</button></div></div>`;
    list.appendChild(d);
    d.querySelector('button').addEventListener('click', ()=> openChatModal(o.user, o.id));
  });
}

/* Chat Modal */
async function openChatModal(user, orderId){
  const modal = document.createElement('div'); modal.className='modal'; modal.id='chatModal';
  modal.innerHTML = `<button class="close" id="closeChatModal">‚úï</button><h2>–ß–∞—Ç —Å ${escapeHtml(user)}</h2><div id="chatMessages" style="max-height:300px;overflow:auto;border:1px solid #333;padding:8px;border-radius:6px;margin-bottom:8px"></div><div class="msg-box"><textarea id="chatInput" placeholder="–°–æ–æ–±—â–µ–Ω–∏–µ" style="flex:1"></textarea><button id="sendChatMsg" class="btn">üì§</button></div><div class="chat-note">–°–æ–æ–±—â–µ–Ω–∏–µ —Å–æ—Ö—Ä–∞–Ω–∏—Ç—Å—è –∏ –±—É–¥–µ—Ç –≤–∏–¥–Ω–æ —Ç–æ–ª—å–∫–æ –≤–∞–º</div>`;
  document.body.appendChild(modal);
  showModal('chatModal');
  
  const msgArea = el('chatMessages');
  const loadChatMsg = async ()=>{
    const msg = await loadChat(user, orderId);
    msgArea.innerHTML = msg ? `<div>${escapeHtml(msg)}</div>` : '<div class="muted">–ù–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–π</div>';
  };
  await loadChatMsg();
  
  el('sendChatMsg').onclick = async ()=>{
    const txt = el('chatInput').value.trim();
    if(!txt) return;
    const saved = await saveChat(user, orderId, txt);
    if(saved) { await loadChatMsg(); el('chatInput').value=''; }
    else alert('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è');
  };
  el('closeChatModal').onclick = ()=>{ document.body.removeChild(modal); hideModal('chatModal'); };
}

/* Seller Products */
async function renderSellerProducts(){
  const list = el('productsEditorList'); list.innerHTML='';
  products.forEach(p=>{
    const d = document.createElement('div'); d.className='list-item';
    d.innerHTML = `<div><b>${escapeHtml(p.name)}</b><div class="muted">${p.price} üí∞</div></div><div><button class="ghost" data-edit="${p.id}">‚úèÔ∏è</button><button class="ghost" data-del="${p.id}">‚ùå</button></div>`;
    list.appendChild(d);
    d.querySelector(`button[data-edit="${p.id}"]`).addEventListener('click', ()=> openProductEdit(p.id));
    d.querySelector(`button[data-del="${p.id}"]`).addEventListener('click', async ()=>{ 
      if(confirm('–£–¥–∞–ª–∏—Ç—å?')){ 
        products = products.filter(x=>x.id!==p.id); 
        const saved = await saveJSON(KEY_PRODUCTS, products);
        if(saved) renderSellerProducts(); 
        else alert('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è');
      } 
    });
  });
}

el('btnNewProduct').addEventListener('click', ()=> openProductEdit(null));

function openProductEdit(prodId){
  const p = prodId ? products.find(x=>x.id===prodId) : null;
  el('editTitle').textContent = p ? '–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —Ç–æ–≤–∞—Ä' : '–î–æ–±–∞–≤–∏—Ç—å —Ç–æ–≤–∞—Ä';
  const form = el('productEditForm'); form.innerHTML='';
  
  const fields = [
    {tag:'input', id:'pe_name', label:'–ù–∞–∑–≤–∞–Ω–∏–µ', type:'text', value:p?.name||''},
    {tag:'input', id:'pe_price', label:'–¶–µ–Ω–∞', type:'number', value:p?.price||0},
    {tag:'input', id:'pe_img', label:'–ö–∞—Ä—Ç–∏–Ω–∫–∞ (URL)', type:'text', value:p?.img||''},
    {tag:'select', id:'pe_category', label:'–ö–∞—Ç–µ–≥–æ—Ä–∏—è', options: cats.mains.map(m=>({value:m.id, text:m.title})), value:p?.category||''},
    {tag:'select', id:'pe_subcategory', label:'–ü–æ–¥–∫–∞—Ç–µ–≥–æ—Ä–∏—è', options: [], value:p?.subcategory||''},
    {tag:'input', id:'pe_caliber', label:'–ö–∞–ª–∏–±—Ä', type:'text', value:p?.caliber||''},
    {tag:'textarea', id:'pe_desc', label:'–û–ø–∏—Å–∞–Ω–∏–µ', value:p?.description||''}
  ];
  
  fields.forEach(f=>{
    const row = document.createElement('div'); row.className='form-row';
    const col = document.createElement('div'); col.className='form-col';
    const lbl = document.createElement('label'); lbl.textContent = f.label; lbl.htmlFor = f.id;
    col.appendChild(lbl);
    let elm;
    if(f.tag==='select'){
      elm = document.createElement('select'); elm.id = f.id;
      f.options.forEach(opt=>{ const o = document.createElement('option'); o.value=opt.value; o.textContent=opt.text; if(f.value===opt.value) o.selected=true; elm.appendChild(o); });
    } else if(f.tag==='textarea'){
      elm = document.createElement('textarea'); elm.id = f.id; elm.value = f.value||'';
    } else {
      elm = document.createElement('input'); elm.type = f.type; elm.id = f.id; elm.value = f.value||'';
    }
    col.appendChild(elm); row.appendChild(col); form.appendChild(row);
  });
  
  // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–æ–¥–∫–∞—Ç–µ–≥–æ—Ä–∏–π –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
  el('pe_category').addEventListener('change', ()=> updateSubcatOptions());
  function updateSubcatOptions(){
    const mainId = el('pe_category').value;
    const subSel = el('pe_subcategory'); subSel.innerHTML='';
    const subs = cats.subs[mainId] || [];
    subs.forEach(sc=>{ const o = document.createElement('option'); o.value=sc.id; o.textContent=sc.title; subSel.appendChild(o); });
    if(p && p.category===mainId) subSel.value = p.subcategory||'';
  }
  updateSubcatOptions();
  
  // Attachments editor
  const attachRow = document.createElement('div'); attachRow.className='form-row';
  const attachCol = document.createElement('div'); attachCol.className='form-col';
  attachCol.innerHTML = '<label>–û–±–≤–µ—Å—ã</label><div id="pe_attachments_list"></div><div class="attach-row"><select id="pe_attach_type"><option value="">–í—ã–±–µ—Ä–∏—Ç–µ —Ç–∏–ø</option>'+cats.attachTypes.map(t=>`<option value="${t}">${t}</option>`).join('')+'</select><input id="pe_attach_name" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ"><input id="pe_attach_price" placeholder="–¶–µ–Ω–∞" type="number"><input id="pe_attach_img" placeholder="–ö–∞—Ä—Ç–∏–Ω–∫–∞ (URL)"><button id="pe_attach_add" class="ghost">+</button></div><div class="small-muted">–î–ª—è –∫–æ–ª–∏—á–µ—Å—Ç–≤–µ–Ω–Ω—ã—Ö –æ–±–≤–µ—Å–æ–≤ –¥–æ–±–∞–≤—å—Ç–µ " (xN)" –≤ –∫–æ–Ω—Ü–µ –Ω–∞–∑–≤–∞–Ω–∏—è</div>';
  attachRow.appendChild(attachCol); form.appendChild(attachRow);
  
  const attachList = el('pe_attachments_list');
  const currentAttach = p ? JSON.parse(JSON.stringify(p.attachments||{})) : {};
  function renderAttachmentsList(){
    attachList.innerHTML='';
    Object.keys(currentAttach).forEach(type=>{
      currentAttach[type].forEach((att, idx)=>{
        const d = document.createElement('div'); d.className='attach-row';
        d.innerHTML = `<span>${type}: ${att.name} (${att.price}üí∞)</span><button class="ghost" data-type="${type}" data-idx="${idx}">‚ùå</button>`;
        attachList.appendChild(d);
        d.querySelector('button').addEventListener('click', ()=>{
          currentAttach[type].splice(idx,1);
          if(currentAttach[type].length===0) delete currentAttach[type];
          renderAttachmentsList();
        });
      });
    });
  }
  renderAttachmentsList();
  
  el('pe_attach_add').addEventListener('click', ()=>{
    const type = el('pe_attach_type').value, name = el('pe_attach_name').value.trim(), price = parseInt(el('pe_attach_price').value)||0, img = el('pe_attach_img').value.trim();
    if(!type || !name || !price) return alert('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ —Ç–∏–ø, –Ω–∞–∑–≤–∞–Ω–∏–µ –∏ —Ü–µ–Ω—É');
    if(!currentAttach[type]) currentAttach[type] = [];
    currentAttach[type].push({ name, price, img });
    renderAttachmentsList();
    el('pe_attach_name').value=''; el('pe_attach_price').value=''; el('pe_attach_img').value='';
  });
  
  // Save button
  const saveRow = document.createElement('div'); saveRow.className='form-row';
  const saveCol = document.createElement('div'); saveCol.className='form-col';
  saveCol.innerHTML = `<button id="pe_save" class="btn">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>`;
  saveRow.appendChild(saveCol); form.appendChild(saveRow);
  
  el('pe_save').addEventListener('click', async ()=>{
    const newP = {
      id: p ? p.id : Math.max(0, ...products.map(x=>x.id)) + 1,
      name: el('pe_name').value.trim(),
      price: parseInt(el('pe_price').value)||0,
      img: el('pe_img').value.trim(),
      category: el('pe_category').value,
      subcategory: el('pe_subcategory').value || undefined,
      caliber: el('pe_caliber').value.trim() || undefined,
      description: el('pe_desc').value.trim(),
      attachments: currentAttach
    };
    if(!newP.name || !newP.price || !newP.category) return alert('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ, —Ü–µ–Ω—É –∏ –∫–∞—Ç–µ–≥–æ—Ä–∏—é');
    
    if(p) {
      const idx = products.findIndex(x=>x.id===p.id);
      if(idx>=0) products[idx] = newP;
    } else {
      products.push(newP);
    }
    
    const saved = await saveJSON(KEY_PRODUCTS, products);
    if(saved) { 
      hideModal('productModalEdit'); 
      renderSellerProducts(); 
      renderProducts(); 
    } else {
      alert('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è');
    }
  });
  
  showModal('productModalEdit');
}

/* Seller Categories */
function renderSellerCategories(){
  // Main cats
  const mainList = el('mainCategoriesList'); mainList.innerHTML='';
  cats.mains.forEach((m,idx)=>{
    const d = document.createElement('div'); d.className='list-item';
    d.innerHTML = `<div>${escapeHtml(m.title)}</div><div><button class="ghost" data-del-main="${idx}">‚ùå</button></div>`;
    mainList.appendChild(d);
    d.querySelector(`button[data-del-main="${idx}"]`).addEventListener('click', async ()=>{ 
      if(confirm('–£–¥–∞–ª–∏—Ç—å –∫–∞—Ç–µ–≥–æ—Ä–∏—é?')){ 
        cats.mains.splice(idx,1); 
        const saved = await saveJSON(KEY_CATS, cats);
        if(saved) renderSellerCategories(); 
        else alert('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è');
      } 
    });
  });
  
  // Subcats
  const subSel = el('subForMain'); subSel.innerHTML='<option value="">–í—ã–±–µ—Ä–∏—Ç–µ –∫–∞—Ç–µ–≥–æ—Ä–∏—é</option>';
  cats.mains.forEach(m=>{ const o = document.createElement('option'); o.value=m.id; o.textContent=m.title; subSel.appendChild(o); });
  subSel.addEventListener('change', ()=> renderSubcatsList());
  function renderSubcatsList(){
    const mainId = subSel.value;
    const list = el('subCatsList'); list.innerHTML='';
    if(!mainId) return;
    const subs = cats.subs[mainId] || [];
    subs.forEach((sc,idx)=>{
      const d = document.createElement('div'); d.className='list-item';
      d.innerHTML = `<div>${escapeHtml(sc.title)}</div><div><button class="ghost" data-del-sub="${mainId},${idx}">‚ùå</button></div>`;
      list.appendChild(d);
      d.querySelector(`button[data-del-sub="${mainId},${idx}"]`).addEventListener('click', async ()=>{ 
        if(confirm('–£–¥–∞–ª–∏—Ç—å –ø–æ–¥–∫–∞—Ç–µ–≥–æ—Ä–∏—é?')){ 
          cats.subs[mainId].splice(idx,1); 
          const saved = await saveJSON(KEY_CATS, cats);
          if(saved) renderSubcatsList(); 
          else alert('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è');
        } 
      });
    });
  }
  
  // Attach types
  const attachList = el('attachTypesList'); attachList.innerHTML='';
  cats.attachTypes.forEach((t,idx)=>{
    const d = document.createElement('div'); d.className='list-item';
    d.innerHTML = `<div>${escapeHtml(t)}</div><div><button class="ghost" data-del-attach="${idx}">‚ùå</button></div>`;
    attachList.appendChild(d);
    d.querySelector(`button[data-del-attach="${idx}"]`).addEventListener('click', async ()=>{ 
      if(confirm('–£–¥–∞–ª–∏—Ç—å —Ç–∏–ø –æ–±–≤–µ—Å–∞?')){ 
        cats.attachTypes.splice(idx,1); 
        const saved = await saveJSON(KEY_CATS, cats);
        if(saved) renderSellerCategories(); 
        else alert('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è');
      } 
    });
  });
}

el('btnAddMainCat').addEventListener('click', async ()=>{
  const name = el('newMainCat').value.trim(); if(!name) return;
  const id = slug(name);
  if(cats.mains.find(m=>m.id===id)) return alert('–ö–∞—Ç–µ–≥–æ—Ä–∏—è —É–∂–µ –µ—Å—Ç—å');
  cats.mains.push({id, title:name});
  const saved = await saveJSON(KEY_CATS, cats);
  if(saved) { el('newMainCat').value=''; renderSellerCategories(); renderCategoryFilter(); } 
  else alert('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è');
});

el('btnAddSubCat').addEventListener('click', async ()=>{
  const mainId = el('subForMain').value, name = el('newSubCat').value.trim();
  if(!mainId || !name) return;
  const id = slug(name);
  if(!cats.subs[mainId]) cats.subs[mainId] = [];
  if(cats.subs[mainId].find(s=>s.id===id)) return alert('–ü–æ–¥–∫–∞—Ç–µ–≥–æ—Ä–∏—è —É–∂–µ –µ—Å—Ç—å');
  cats.subs[mainId].push({id, title:name});
  const saved = await saveJSON(KEY_CATS, cats);
  if(saved) { el('newSubCat').value=''; renderSubcatsList(); renderCategoryFilter(); } 
  else alert('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è');
});

el('btnAddAttachType').addEventListener('click', async ()=>{
  const name = el('newAttachType').value.trim(); if(!name) return;
  if(cats.attachTypes.includes(name)) return alert('–¢–∏–ø —É–∂–µ –µ—Å—Ç—å');
  cats.attachTypes.push(name);
  const saved = await saveJSON(KEY_CATS, cats);
  if(saved) { el('newAttachType').value=''; renderSellerCategories(); } 
  else alert('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è');
});

/* -------------------------
   Utils
   ------------------------- */
function escapeHtml(unsafe){ if(!unsafe) return ''; return unsafe.toString().replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/"/g, "&quot;").replace(/'/g, "&#039;"); }
function getCatTitle(id){ const m = cats.mains.find(m=>m.id===id); return m?m.title:''; }
function getSubTitle(mainId, subId){ const m = cats.subs[mainId]; if(!m) return ''; const s = m.find(s=>s.id===subId); return s?s.title:''; }

/* -------------------------
   Init
   ------------------------- */
async function init(){
  await initializeData();
  renderCategoryFilter();
  renderProducts();
  updateCartUI();
  updateUserUI();
}

init();
</script>
</body>
</html>