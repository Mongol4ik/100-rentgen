<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>–ú–∞–≥–∞–∑–∏–Ω "100 –†–µ–Ω—Ç–≥–µ–Ω"</title>
<style>
  :root{
    --accent:#ff9800;
    --bg:#850000;
    --panel-bg:rgba(18,18,18,0.96);
    --muted:#9aa;
    --card:#101010;
    --glass: rgba(255,255,255,0.03);
  }
  *{box-sizing:border-box}
  html,body{height:100%;margin:0;font-family:Inter,system-ui,Arial,sans-serif;background:url('https://i.imgur.com/Z1OWJQa.png') center/cover fixed;color:#fff}
  a{color:inherit}
  button,input,select,textarea{font:inherit}
  button{cursor:pointer}

  header{display:flex;justify-content:space-between;align-items:flex-start;padding:12px 18px;background:linear-gradient(180deg,rgba(0,0,0,0.6),rgba(0,0,0,0.2));gap:12px;position:sticky;top:0;z-index:40}
  .brand{display:flex;flex-direction:column}
  .brand h1{margin:0;font-size:18px}
  .controls{display:flex;flex-direction:column;align-items:flex-end;gap:8px}
  .top-buttons{display:flex;gap:8px}

  .categoryFilter{display:flex;gap:8px;align-items:center;overflow:auto;max-width:720px;padding-bottom:6px}
  .categoryFilter button{background:transparent;border:1px solid var(--glass);padding:6px 10px;border-radius:8px;color:#fff}
  .categoryFilter button.active{background:var(--accent);color:#000}

  .subcategoryContainer{margin-top:8px}
  .subcategoryFilter{display:flex;gap:6px;flex-wrap:wrap;max-height:88px;overflow:auto;padding:6px}
  .subcategoryFilter button{background:transparent;border:1px solid var(--glass);padding:6px 8px;border-radius:6px;color:#fff;font-size:13px}
  .subcategoryFilter button.active{background:var(--accent);color:#000}

  .container{padding:18px;display:flex;gap:18px;flex-wrap:wrap;justify-content:flex-start}
  .product-list{display:flex;flex-wrap:wrap;gap:18px}
  .product{width:220px;background:var(--panel-bg);padding:10px;border-radius:10px;border:1px solid var(--glass);cursor:pointer;transition:transform .12s}
  .product:hover{transform:translateY(-6px)}
  .product img{width:100%;height:140px;object-fit:cover;border-radius:6px}
  .product h3{margin:8px 0 4px;font-size:15px}
  .product p{margin:2px 0;color:var(--muted);font-size:13px}

  .panel{position:fixed;right:14px;top:72px;width:520px;max-height:80vh;overflow:auto;background:var(--panel-bg);padding:12px;border-radius:10px;border:1px solid var(--glass);display:none;z-index:60}
  @media(max-width:980px){ .panel{left:14px;right:14px;width:auto} .product{width:calc(50% - 24px)} }

  .list-item{display:flex;justify-content:space-between;gap:8px;padding:8px;border-radius:8px;border:1px solid var(--glass);margin-top:8px;background:linear-gradient(180deg,#0c0c0c,#0a0a0a)}

  .overlay{position:fixed;inset:0;background:rgba(0,0,0,0.6);backdrop-filter:blur(3px);display:none;z-index:50}
  .modal{position:fixed;left:50%;top:50%;transform:translate(-50%,-50%);background:#0b0b0b;padding:16px;border-radius:10px;border:1px solid var(--glass);z-index:60;display:none;max-width:920px;width:92%;max-height:92vh;overflow:auto}
  .modal .close{position:absolute;right:10px;top:8px;background:transparent;border:1px solid var(--glass);color:#fff;padding:6px;border-radius:6px}
  .modal h2{margin:0 0 8px}

  .product-view{
    display:flex;
    gap:24px;
    align-items:flex-start;
    flex-wrap: wrap;
  }
  .product-view-left{
    min-width: 320px;
    flex: 1;
    display: flex;
    justify-content: center;
  }
  .product-view-left img{
    width: 100%;
    max-width: 400px;
    height: 350px;
    object-fit: contain;
    border-radius: 10px;
    background: var(--card);
    padding: 12px;
    border: 1px solid var(--glass);
  }
  .product-view-right{
    flex: 1;
    min-width: 300px;
  }
  .product-view-right h3{
    margin:0 0 12px;
    font-size: 20px;
  }
  .muted{
    color:var(--muted);
    font-size:14px;
  }

  /* –£–í–ï–õ–ò–ß–ï–ù–ù–´–ï –ö–ê–†–¢–ò–ù–ö–ò –î–õ–Ø –û–ë–í–ï–°–û–í */
  .attach-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(180px,1fr));gap:12px;margin-top:8px}
  .attach-card{background:#0d0d0d;border:1px solid var(--glass);padding:12px;border-radius:8px;display:flex;flex-direction:column;align-items:center;text-align:center;transition:.12s;cursor:pointer}
  .attach-card img{width:120px;height:120px;object-fit:contain;border-radius:6px;background:var(--card);padding:8px}
  .attach-card .title{margin-top:8px;font-size:14px;font-weight:500}
  .attach-card .price{font-size:14px;color:var(--muted);margin-top:4px}
  .attach-card .row{margin-top:8px;display:flex;align-items:center;gap:6px}
  .attach-card.selected{border:2px solid var(--accent);background:linear-gradient(180deg, rgba(26,18,0,0.15), rgba(0,0,0,0.05))}

  .form-row{display:flex;gap:8px;flex-wrap:wrap}
  .form-col{flex:1;min-width:160px}
  input,select,textarea{width:100%;padding:8px;border-radius:8px;border:1px solid #222;background:#080808;color:#fff}
  textarea{min-height:80px}

  .btn{background:var(--accent);color:#000;padding:8px;border-radius:8px;border:none}
  .ghost{background:transparent;border:1px solid var(--glass);color:#fff;padding:6px;border-radius:6px}

  .small-muted{font-size:12px;color:var(--muted);margin-top:6px}
  .attach-row{display:flex;gap:8px;align-items:center;margin-top:8px}
  .attach-row input[type="text"], .attach-row input[type="number"], .attach-row select{padding:6px;border-radius:6px;background:#080808;border:1px solid #222;color:#fff}
  .msg-box{margin-top:8px;display:flex;gap:8px}
  .chat-note{margin-top:6px;font-size:13px;color:#ffdca8;background:rgba(255,220,168,0.1);padding:8px;border-radius:6px;border-left:3px solid #ffdca8}

  /* –°—Ç–∏–ª–∏ –¥–ª—è –¥–µ—Ç–∞–ª–µ–π –∑–∞–∫–∞–∑–∞ */
  .order-details{margin-top:8px;padding:8px;background:rgba(255,255,255,0.05);border-radius:6px}
  .order-item{margin-bottom:6px;padding-bottom:6px;border-bottom:1px solid rgba(255,255,255,0.1)}
  .order-item:last-child{border-bottom:none;margin-bottom:0}
  .item-name{font-weight:500}
  .item-attachments{margin-left:12px;font-size:12px;color:var(--muted)}
  .item-qty{color:var(--accent);margin-left:4px}

  /* –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ —Å–æ–æ–±—â–µ–Ω–∏—è—Ö */
  .message-notification{background:rgba(255,152,0,0.2);border:1px solid var(--accent);padding:8px;border-radius:6px;margin-top:6px}

  /* –ó–∞–≥—Ä—É–∑–∫–∞ */
  .loading{opacity:0.7;pointer-events:none}
</style>
</head>
<body>

<header>
  <div class="brand">
    <h1>100 –†–µ–Ω—Ç–≥–µ–Ω ‚Äî –≤–Ω—É—Ç—Ä–∏–∏–≥—Ä–æ–≤–æ–π –º–∞–≥–∞–∑–∏–Ω</h1>
    <div class="muted">–ü—Ä–æ–¥–∞–µ–º –ª—é–¥–µ–π –∏ –±–∞–Ω–∞–Ω—ã.</div>
  </div>

  <div class="controls">
    <div class="top-buttons">
      <button id="btnCart" class="ghost">–ö–æ—Ä–∑–∏–Ω–∞</button>
      <button id="btnLogin" class="ghost">–í—Ö–æ–¥</button>
      <button id="btnMyOrders" class="ghost" style="display:none">–ú–æ–∏ –∑–∞—è–≤–∫–∏</button>
      <button id="btnBets" class="ghost">üé≤ –°—Ç–∞–≤–∫–∏ –Ω–∞ –±–æ–∏</button>
      <button id="btnSeller" class="ghost">–ü–∞–Ω–µ–ª—å –ø—Ä–æ–¥–∞–≤—Ü–∞</button>
    </div>

    <div class="categoryFilter" id="categoryFilter"></div>
    <div class="subcategoryContainer" id="subcategoryContainer"></div>
  </div>
</header>

<main class="container">
  <div id="productList" class="product-list"></div>
</main>

<div id="overlay" class="overlay"></div>

<div id="productModalView" class="modal" aria-hidden="true">
  <button class="close" id="closeProductView">‚úï</button>
  <div id="productViewContent"></div>
</div>

<div id="productModalEdit" class="modal" aria-hidden="true">
  <button class="close" id="closeProductEdit">‚úï</button>
  <h2 id="editTitle">–î–æ–±–∞–≤–∏—Ç—å / –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —Ç–æ–≤–∞—Ä</h2>
  <div id="productEditForm"></div>
</div>

<div id="cartPanel" class="panel">
  <h3>–ö–æ—Ä–∑–∏–Ω–∞</h3>
  <div id="cartItems"></div>
  <p>–ò—Ç–æ–≥–æ: <b id="cartTotal">0</b> üí∞</p>
  <div style="display:flex;gap:8px;justify-content:flex-end">
    <button id="btnCheckout" class="btn">–û—Ñ–æ—Ä–º–∏—Ç—å –∑–∞—è–≤–∫—É</button>
    <button class="ghost" onclick="closeAllPanels()">–ó–∞–∫—Ä—ã—Ç—å</button>
  </div>
</div>

<div id="loginPanel" class="panel">
  <h3>–í—Ö–æ–¥ / –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</h3>
  <input id="username" placeholder="–ò–º—è" />
  <input id="password" placeholder="–ü–∞—Ä–æ–ª—å" type="password" />
  <div style="display:flex;gap:8px;margin-top:8px">
    <button id="btnRegister" class="btn">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</button>
    <button id="btnSignIn" class="btn">–í–æ–π—Ç–∏</button>
    <button class="ghost" onclick="closeAllPanels()">–ó–∞–∫—Ä—ã—Ç—å</button>
  </div>
</div>

<div id="myOrdersPanel" class="panel">
  <h3>–ú–æ–∏ –∑–∞—è–≤–∫–∏</h3>
  <div id="myOrdersList"></div>
  <div style="margin-top:12px">
    <button class="ghost" onclick="closeAllPanels()">–ó–∞–∫—Ä—ã—Ç—å</button>
  </div>
</div>

<div id="sellerPanel" class="panel">
  <h3>–ü–∞–Ω–µ–ª—å –ø—Ä–æ–¥–∞–≤—Ü–∞</h3>
  <div id="sellerLoginArea">
    <input id="sellerPass" placeholder="–ü–∞—Ä–æ–ª—å –ø—Ä–æ–¥–∞–≤—Ü–∞" type="password" />
    <div style="display:flex;gap:8px;margin-top:8px">
      <button id="btnSellerLogin" class="btn">–í–æ–π—Ç–∏</button>
      <button class="ghost" onclick="closeAllPanels()">–ó–∞–∫—Ä—ã—Ç—å</button>
    </div>
  </div>

  <div id="sellerArea" style="display:none;margin-top:12px">
    <div style="display:flex;gap:8px;margin-bottom:8px">
      <button id="tabOrders" class="ghost active">–ó–∞—è–≤–∫–∏</button>
      <button id="tabProducts" class="ghost">–¢–æ–≤–∞—Ä—ã</button>
      <button id="tabCategories" class="ghost">–ö–∞—Ç–µ–≥–æ—Ä–∏–∏</button>
      <button class="ghost" onclick="closeAllPanels()" style="margin-left:auto">–ó–∞–∫—Ä—ã—Ç—å</button>
    </div>

    <div id="sellerOrdersSection">
      <div id="ordersList"></div>
    </div>

    <div id="sellerProductsSection" style="display:none">
      <div id="productsEditorList"></div>
      <div style="margin-top:12px">
        <button id="btnNewProduct" class="btn">‚ûï –î–æ–±–∞–≤–∏—Ç—å —Ç–æ–≤–∞—Ä</button>
      </div>
    </div>

    <div id="sellerCategoriesSection" style="display:none">
      <div style="margin-top:6px">
        <strong>–û—Å–Ω–æ–≤–Ω—ã–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏</strong>
        <div id="mainCategoriesList"></div>
        <div style="display:flex;gap:8px;margin-top:8px">
          <input id="newMainCat" placeholder="–î–æ–±–∞–≤–∏—Ç—å –∫–∞—Ç–µ–≥–æ—Ä–∏—é" />
          <button id="btnAddMainCat" class="btn">–î–æ–±–∞–≤–∏—Ç—å</button>
        </div>
      </div>

      <div style="margin-top:12px">
        <strong>–ü–æ–¥–∫–∞—Ç–µ–≥–æ—Ä–∏–∏ (–≤—ã–±–µ—Ä–∏—Ç–µ –æ—Å–Ω–æ–≤–Ω—É—é)</strong>
        <select id="subForMain"></select>
        <div id="subCatsList" style="margin-top:8px;max-height:180px;overflow:auto"></div>
        <div style="display:flex;gap:8px;margin-top:8px">
          <input id="newSubCat" placeholder="–î–æ–±–∞–≤–∏—Ç—å –ø–æ–¥–∫–∞—Ç–µ–≥–æ—Ä–∏—é" />
          <button id="btnAddSubCat" class="btn">–î–æ–±–∞–≤–∏—Ç—å</button>
        </div>
      </div>

      <div style="margin-top:12px">
        <strong>–¢–∏–ø—ã –æ–±–≤–µ—Å–æ–≤</strong>
        <div id="attachTypesList"></div>
        <div style="display:flex;gap:8px;margin-top:8px">
          <input id="newAttachType" placeholder="–î–æ–±–∞–≤–∏—Ç—å —Ç–∏–ø –æ–±–≤–µ—Å–∞" />
          <button id="btnAddAttachType" class="btn">–î–æ–±–∞–≤–∏—Ç—å</button>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
/* -------------------------
   JSONBin Configuration - –ó–ê–ú–ï–ù–ò–¢–ï –ù–ê –í–ê–®–ò –î–ê–ù–ù–´–ï!
   ------------------------- */
const JSONBIN_BASE_URL = 'https://api.jsonbin.io/v3/b';
const JSONBIN_MASTER_KEY = '$2a$10$wTicXNpl/tYWk2p1tuUuC.w87l4en0x8a9e7STVUKFIfFQnaZFdLC'; // –ó–ê–ú–ï–ù–ò–¢–ï!
const JSONBIN_ACCESS_KEY = '$2a$10$.twuYFU3QYQ1ZXPY.uyfB.7EryqBOUndWb3UbhjCfknwxJvHKo2LG'; // –ó–ê–ú–ï–ù–ò–¢–ï!

const JSONBIN_IDS = {
  PRODUCTS: '6904f4cbae596e708f3ab82d',      // –ó–ê–ú–ï–ù–ò–¢–ï!
  USERS: '6904f5d843b1c97be98eff3a',           // –ó–ê–ú–ï–ù–ò–¢–ï!
  CATS: '6904f52243b1c97be98efe37',            // –ó–ê–ú–ï–ù–ò–¢–ï!
  CHATS: '6904f602ae596e708f3aba24',           // –ó–ê–ú–ï–ù–ò–¢–ï!
  CONFIG: '69050c5343b1c97be98f23c9'
};


/* -------------------------
   Storage & defaults
   ------------------------- */
const KEY_PRODUCTS = 'products_v_final_v1';
const KEY_USERS = 'users_v_final_v1';
const KEY_CATS = 'cats_v_final_v1';
const KEY_CHATS = 'chats_v1';
const KEY_CURRENT_USER = 'currentUser';
const KEY_SELLER_CONFIG = 'sellerConfig';

const DEFAULT_CATS = {
  mains: [
    {id:'weapon', title:'–û—Ä—É–∂–∏–µ'},
    {id:'armor', title:'–ë—Ä–æ–Ω—è'},
    {id:'attachments', title:'–û–±–≤–µ—Å—ã'},
    {id:'consumable', title:'–†–∞—Å—Ö–æ–¥–Ω–∏–∫–∏'}
  ],
  subs: {
    weapon: [
      {id:'sniper', title:'–°–Ω–∞–π–ø–µ—Ä—Å–∫–∏–µ'},
      {id:'assault', title:'–®—Ç—É—Ä–º–æ–≤—ã–µ'},
      {id:'smg', title:'–ü–ü'},
      {id:'pistol', title:'–ü–∏—Å—Ç–æ–ª–µ—Ç—ã'}
    ],
    armor: [
      {id:'body', title:'–ë—Ä–æ–Ω—è'},
      {id:'helmet', title:'–®–ª–µ–º—ã'}
    ],
    attachments:[
      {id:'sight', title:'–ü—Ä–∏—Ü–µ–ª—ã'},
      {id:'grip', title:'–†—É—á–∫–∏'},
      {id:'stock', title:'–ü—Ä–∏–∫–ª–∞–¥—ã'}
    ]
  },
  attachTypes: ['–ü—Ä–∏—Ü–µ–ª—ã','–†—É—á–∫–∏','–ü—Ä–∏–∫–ª–∞–¥—ã','–¶–µ–≤—å—è','–ú–∞–≥–∞–∑–∏–Ω']
};

const DEFAULT_PRODUCTS = [
  { id:1, name:'–ü–∏—Å—Ç–æ–ª–µ—Ç –ü–ú', price:120, img:'https://i.imgur.com/7bHnZ0f.png', category:'weapon', subcategory:'pistol', caliber:'9x18mm', description:'–ù–∞–¥—ë–∂–Ω—ã–π –ø–∏—Å—Ç–æ–ª–µ—Ç –±–ª–∏–∂–Ω–µ–≥–æ –±–æ—è.', attachments: { '–ü—Ä–∏—Ü–µ–ª—ã': [{name:'–ö–æ–ª–ª–∏–º–∞—Ç–æ—Ä', price:60, img:'https://i.imgur.com/y1svLkP.png'}] } },
  { id:2, name:'–í–∏–Ω—Ç–æ–≤–∫–∞ –ê–ö', price:420, img:'https://i.imgur.com/t2G6M0l.png', category:'weapon', subcategory:'assault', caliber:'7.62x39mm', description:'–ö–ª–∞—Å—Å–∏—á–µ—Å–∫–∞—è —à—Ç—É—Ä–º–æ–≤–∞—è –≤–∏–Ω—Ç–æ–≤–∫–∞.', attachments: { '–ü—Ä–∏—Ü–µ–ª—ã': [{name:'–û–ø—Ç–∏–∫–∞ 4x', price:200, img:'https://i.imgur.com/I4bZpPZ.png'}], '–ü—Ä–∏–∫–ª–∞–¥—ã': [{name:'–°–∫–ª–∞–¥–Ω–æ–π –ø—Ä–∏–∫–ª–∞–¥', price:150, img:'https://i.imgur.com/1YhTVEr.png'}] } },
  { id:3, name:'–ö–æ–º–±–∏–Ω–µ–∑–æ–Ω', price:300, img:'https://i.imgur.com/Q9P6S0R.png', category:'armor', subcategory:'body', caliber:'', description:'–ó–∞—â–∏—Ç–Ω—ã–π –∫–æ–º–±–µ–∑ –¥–ª—è —Ä–µ–π–¥–æ–≤.', attachments: {} }
];

const DEFAULT_CONFIG = {
  sellerPassword: 'admin123'
};

let products = [];
let cats = {};
let users = {};
let currentUser = localStorage.getItem(KEY_CURRENT_USER) || null;
let cart = [];
let sellerConfig = DEFAULT_CONFIG;
let selectedCategory = 'all';
let selectedSubcategory = null;
let isLoading = false;

/* -------------------------
   JSONBin Helpers
   ------------------------- */
async function jsonbinFetch(binId, options = {}) {
  const url = `${JSONBIN_BASE_URL}/${binId}/latest`;
  const headers = {
    'Content-Type': 'application/json',
    'X-Master-Key': JSONBIN_MASTER_KEY,
    'X-Access-Key': JSONBIN_ACCESS_KEY,
    ...options.headers
  };
  
  try {
    const response = await fetch(url, { ...options, headers });
    if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
    const data = await response.json();
    return data.record;
  } catch (error) {
    console.error('JSONBin fetch error:', error);
    // Fallback to localStorage if JSONBin fails
    const fallback = localStorage.getItem(`fallback_${binId}`);
    return fallback ? JSON.parse(fallback) : null;
  }
}

async function jsonbinUpdate(binId, data) {
  const url = `${JSONBIN_BASE_URL}/${binId}`;
  const headers = {
    'Content-Type': 'application/json',
    'X-Master-Key': JSONBIN_MASTER_KEY,
    'X-Access-Key': JSONBIN_ACCESS_KEY
  };
  
  try {
    const response = await fetch(url, {
      method: 'PUT',
      headers: headers,
      body: JSON.stringify(data)
    });
    
    if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
    const result = await response.json();
    
    // Also save to localStorage as backup
    localStorage.setItem(`fallback_${binId}`, JSON.stringify(data));
    
    return result.record;
  } catch (error) {
    console.error('JSONBin update error:', error);
    // Fallback to localStorage
    localStorage.setItem(`fallback_${binId}`, JSON.stringify(data));
    return data;
  }
}

async function loadJSON(key, fallback) {
  try {
    let binId;
    switch(key) {
      case KEY_PRODUCTS: binId = JSONBIN_IDS.PRODUCTS; break;
      case KEY_USERS: binId = JSONBIN_IDS.USERS; break;
      case KEY_CATS: binId = JSONBIN_IDS.CATS; break;
      case KEY_CHATS: binId = JSONBIN_IDS.CHATS; break;
      case KEY_SELLER_CONFIG: binId = JSONBIN_IDS.CONFIG; break;
      default: return JSON.parse(JSON.stringify(fallback));
    }
    
    const data = await jsonbinFetch(binId);
    return data || JSON.parse(JSON.stringify(fallback));
  } catch(e) {
    console.error('Load error:', e);
    return JSON.parse(JSON.stringify(fallback));
  }
}

async function saveJSON(key, val) {
  try {
    let binId;
    switch(key) {
      case KEY_PRODUCTS: binId = JSONBIN_IDS.PRODUCTS; break;
      case KEY_USERS: binId = JSONBIN_IDS.USERS; break;
      case KEY_CATS: binId = JSONBIN_IDS.CATS; break;
      case KEY_CHATS: binId = JSONBIN_IDS.CHATS; break;
      case KEY_SELLER_CONFIG: binId = JSONBIN_IDS.CONFIG; break;
      default: return;
    }
    
    await jsonbinUpdate(binId, val);
    return true;
  } catch(e) {
    console.error('Save error:', e);
    return false;
  }
}

const el = id => document.getElementById(id);

/* Chat helpers */
function chatKey(user, orderId){ return `${user}|${orderId}`; }
async function loadChats(){ return await loadJSON(KEY_CHATS, {}); }
async function saveChats(obj){ return await saveJSON(KEY_CHATS, obj); }
async function loadChat(user, orderId){ const all = await loadChats(); return all[chatKey(user,orderId)] || ''; }
async function saveChat(user, orderId, msg){ const all = await loadChats(); all[chatKey(user,orderId)] = msg; return await saveChats(all); }

/* -------------------------
   Data Initialization
   ------------------------- */
async function initializeData() {
  if (isLoading) return;
  isLoading = true;
  
  try {
    document.body.classList.add('loading');
    
    const [productsData, usersData, catsData, configData] = await Promise.all([
      loadJSON(KEY_PRODUCTS, DEFAULT_PRODUCTS),
      loadJSON(KEY_USERS, {}),
      loadJSON(KEY_CATS, DEFAULT_CATS),
      loadJSON(KEY_SELLER_CONFIG, DEFAULT_CONFIG)
    ]);
    
    products = productsData;
    users = usersData;
    cats = catsData;
    sellerConfig = configData;
    
    console.log('Data loaded:', { products, users, cats, sellerConfig });
  } catch (error) {
    console.error('Data initialization failed:', error);
    // Fallback to defaults
    products = JSON.parse(JSON.stringify(DEFAULT_PRODUCTS));
    users = {};
    cats = JSON.parse(JSON.stringify(DEFAULT_CATS));
    sellerConfig = DEFAULT_CONFIG;
  } finally {
    document.body.classList.remove('loading');
    isLoading = false;
  }
}

/* -------------------------
   Panels toggling - –ò–°–ü–†–ê–í–õ–ï–ù–ù–ê–Ø –õ–û–ì–ò–ö–ê
   ------------------------- */
function closeAllPanels(){
  // –°–∫—Ä—ã–≤–∞–µ–º –≤—Å–µ –ø–∞–Ω–µ–ª–∏
  ['cartPanel','loginPanel','myOrdersPanel','sellerPanel'].forEach(id => {
    const panel = el(id);
    if(panel) panel.style.display = 'none';
  });
  
  // –°–∫—Ä—ã–≤–∞–µ–º –≤—Å–µ –º–æ–¥–∞–ª—å–Ω—ã–µ –æ–∫–Ω–∞
  ['productModalView','productModalEdit'].forEach(id => {
    const modal = el(id);
    if(modal) modal.style.display = 'none';
  });
  
  // –°–∫—Ä—ã–≤–∞–µ–º –æ–≤–µ—Ä–ª–µ–π
  const overlay = document.getElementById('overlay');
  if(overlay) overlay.style.display = 'none';
  
  // –£–¥–∞–ª—è–µ–º –≤—Å–µ —Å–æ–∑–¥–∞–Ω–Ω—ã–µ –º–æ–¥–∞–ª—å–Ω—ã–µ –æ–∫–Ω–∞ —á–∞—Ç–æ–≤
  document.querySelectorAll('.modal').forEach(modal => {
    if(!modal.id) modal.remove();
  });
}

function togglePanel(panelId){
  // –ï—Å–ª–∏ –ø–∞–Ω–µ–ª—å —É–∂–µ –æ—Ç–∫—Ä—ã—Ç–∞ - –∑–∞–∫—Ä—ã–≤–∞–µ–º –µ—ë
  const panel = el(panelId);
  if(panel.style.display === 'block') {
    closeAllPanels();
    return;
  }
  
  // –ó–∞–∫—Ä—ã–≤–∞–µ–º –≤—Å–µ –æ—Å—Ç–∞–ª—å–Ω–æ–µ –∏ –æ—Ç–∫—Ä—ã–≤–∞–µ–º –Ω—É–∂–Ω—É—é –ø–∞–Ω–µ–ª—å
  closeAllPanels();
  panel.style.display = 'block';
  document.getElementById('overlay').style.display = 'block';
}

// –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–ª–∏–∫–∞ –Ω–∞ –æ–≤–µ—Ä–ª–µ–π - –∑–∞–∫—Ä—ã–≤–∞–µ—Ç –≤—Å–µ
document.getElementById('overlay').addEventListener('click', closeAllPanels);

// –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –∫–Ω–æ–ø–æ–∫
el('btnCart').addEventListener('click', (e) => {
  e.stopPropagation();
  togglePanel('cartPanel');
});

el('btnLogin').addEventListener('click', (e) => {
  e.stopPropagation();
  togglePanel('loginPanel');
});

el('btnMyOrders').addEventListener('click', (e) => {
  e.stopPropagation();
  renderMyOrders();
  togglePanel('myOrdersPanel');
});
el('btnBets').addEventListener('click', (e) => {
  e.stopPropagation();
  window.location.href = 'bets.html';
});

el('btnSeller').addEventListener('click', (e) => {
  e.stopPropagation();
  togglePanel('sellerPanel');
  // Reset seller login
  el('sellerLoginArea').style.display = 'block';
  el('sellerArea').style.display = 'none';
  el('sellerPass').value = '';
});

/* -------------------------
   Category rendering
   ------------------------- */
function slug(s){ return String(s||'').toLowerCase().replace(/\s+/g,'_').replace(/[^a-z0-9_]/gi,''); }

function renderCategoryFilter(){
  const wrap = el('categoryFilter'); wrap.innerHTML='';
  const all = document.createElement('button'); all.textContent='–í—Å–µ'; if(selectedCategory==='all') all.classList.add('active');
  all.onclick = ()=>{ selectedCategory='all'; selectedSubcategory=null; renderCategoryFilter(); renderSubcats(null); renderProducts(); };
  wrap.appendChild(all);
  cats.mains.forEach(m=>{
    const b = document.createElement('button'); b.textContent = m.title;
    if(selectedCategory===m.id) b.classList.add('active');
    b.onclick = ()=>{ selectedCategory=m.id; selectedSubcategory=null; renderCategoryFilter(); renderSubcats(m.id); renderProducts(); };
    wrap.appendChild(b);
  });
}

function renderSubcats(mainId){
  const container = el('subcategoryContainer'); container.innerHTML='';
  if(!mainId || !cats.subs[mainId] || !cats.subs[mainId].length) return;
  const wrap = document.createElement('div'); wrap.className='subcategoryFilter';
  const bAll = document.createElement('button'); bAll.textContent='–í—Å–µ –ø–æ–¥–∫–∞—Ç–µ–≥–æ—Ä–∏–∏';
  if(!selectedSubcategory) bAll.classList.add('active');
  bAll.onclick = ()=>{ selectedSubcategory=null; Array.from(wrap.querySelectorAll('button')).forEach(x=>x.classList.remove('active')); bAll.classList.add('active'); renderProducts(); };
  wrap.appendChild(bAll);
  cats.subs[mainId].forEach(sc=>{
    const b = document.createElement('button'); b.textContent = sc.title;
    if(selectedSubcategory === sc.id) b.classList.add('active');
    b.onclick = ()=>{ selectedSubcategory = sc.id; Array.from(wrap.querySelectorAll('button')).forEach(x=>x.classList.remove('active')); b.classList.add('active'); renderProducts(); };
    wrap.appendChild(b);
  });
  container.appendChild(wrap);
}

/* -------------------------
   Products render
   ------------------------- */
function renderProducts(){
  const list = el('productList'); list.innerHTML='';
  
  if (products.length === 0) {
    list.innerHTML = '<div class="muted" style="padding:20px;text-align:center">–¢–æ–≤–∞—Ä–æ–≤ –ø–æ–∫–∞ –Ω–µ—Ç</div>';
    return;
  }
  
  const filteredProducts = products.filter(p=>{
    if(selectedCategory!=='all' && p.category !== selectedCategory) return false;
    if(selectedSubcategory && p.subcategory && p.subcategory !== selectedSubcategory) return false;
    return true;
  });
  
  if (filteredProducts.length === 0) {
    list.innerHTML = '<div class="muted" style="padding:20px;text-align:center">–¢–æ–≤–∞—Ä—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</div>';
    return;
  }
  
  filteredProducts.forEach(p=>{
    const d = document.createElement('div'); d.className='product'; d.dataset.id = p.id;
    d.innerHTML = `<img src="${p.img||''}" alt="${escapeHtml(p.name)}"><h3>${escapeHtml(p.name)}</h3><p class="muted">${p.caliber?p.caliber+' ‚Ä¢ ':''}${getCatTitle(p.category)} ${p.subcategory?'/ '+getSubTitle(p.category,p.subcategory):''}</p><p><b>${p.price} üí∞</b></p>`;
    d.addEventListener('click', ()=> openProductView(p.id));
    list.appendChild(d);
  });
}

/* -------------------------
   Product view modal (attachments selection + total)
   ------------------------- */
function openProductView(prodId){
  const p = products.find(x=>x.id===prodId); if(!p) return;
  const wrap = el('productViewContent'); wrap.innerHTML='';
  const content = document.createElement('div'); content.className='product-view';
  const left = document.createElement('div'); left.className='product-view-left'; left.innerHTML=`<img src="${p.img||''}" alt="${escapeHtml(p.name)}">`;
  const right = document.createElement('div'); right.className='product-view-right';
  right.innerHTML = `<h3>${escapeHtml(p.name)}</h3><p class="muted">–ö–∞—Ç–µ–≥–æ—Ä–∏—è: ${getCatTitle(p.category)} ${p.subcategory?'/ '+getSubTitle(p.category,p.subcategory):''}</p><p class="muted">–ö–∞–ª–∏–±—Ä: ${p.caliber||'‚Äî'}</p><p style="margin-top:8px">${escapeHtml(p.description||'')}</p><p style="margin-top:8px"><b>–ë–∞–∑–∞: ${p.price} üí∞</b></p><div id="pv_attach_area"></div><div style="margin-top:8px" class="total-line">–ò—Ç–æ–≥–æ: <b id="pv_build_total">${p.price}</b> üí∞</div><div style="display:flex;gap:8px;margin-top:12px;justify-content:flex-end"><button id="pv_add_to_cart" class="btn">–î–æ–±–∞–≤–∏—Ç—å –≤ –∫–æ—Ä–∑–∏–Ω—É</button><button id="pv_close" class="ghost">–ó–∞–∫—Ä—ã—Ç—å</button></div>`;
  content.appendChild(left); content.appendChild(right); wrap.appendChild(content);

  // attachments grid
  const attachArea = el('pv_attach_area'); attachArea.innerHTML='<strong>–û–±–≤–µ—Å—ã:</strong>';
  const grid = document.createElement('div'); grid.className='attach-grid';
  const attachTypes = Object.keys(p.attachments || {});
  const chosen = [];
  
  function updateTotalAndHighlight(){
    const extra = chosen.reduce((s,a)=>s + (a.price * (a.quantity || 1)), 0);
    el('pv_build_total').textContent = p.price + extra;
    
    grid.querySelectorAll('.attach-card').forEach(card=>{
      const t = card.dataset.type, n = card.dataset.name;
      const chosenItem = chosen.find(c=>c.type===t && c.name===n);
      
      if(chosenItem) {
        card.classList.add('selected');
        const select = card.querySelector('.quantity-select');
        if(select) select.value = chosenItem.quantity || 0;
        const checkbox = card.querySelector('input[type=checkbox]');
        if(checkbox) checkbox.checked = true;
      } else {
        card.classList.remove('selected');
        const select = card.querySelector('.quantity-select');
        if(select) select.value = 0;
        const checkbox = card.querySelector('input[type=checkbox]');
        if(checkbox) checkbox.checked = false;
      }
    });
  }
  
  if(attachTypes.length===0) grid.innerHTML = '<div class="muted" style="padding:8px">–ù–µ—Ç –æ–±–≤–µ—Å–æ–≤</div>';
  else {
    attachTypes.forEach(type=>{
      (p.attachments[type]||[]).forEach(opt=>{
        const card = document.createElement('div'); 
        card.className='attach-card';
        card.dataset.type = type; 
        card.dataset.name = opt.name;
        
        if(opt.quantity) {
          card.innerHTML = `
            <img src="${opt.img||''}" alt="${escapeHtml(opt.name)}">
            <div class="title">${escapeHtml(opt.name)}</div>
            <div class="price">${opt.price} üí∞/—à—Ç</div>
            <div class="row">
              <select class="quantity-select" style="background:#080808;color:#fff;border:1px solid #333;border-radius:4px;padding:2px">
                <option value="0">0</option>
                <option value="1">1</option>
                <option value="2">2</option>
                <option value="3">3</option>
                <option value="4">4</option>
                <option value="5">5</option>
                <option value="6">6</option>
                <option value="7">7</option>
                <option value="8">8</option>
                <option value="9">9</option>
                <option value="10">10</option>
              </select>
            </div>
          `;
          
          const select = card.querySelector('.quantity-select');
          select.addEventListener('change', ()=>{
            const qty = parseInt(select.value);
            const existingIdx = chosen.findIndex(x=>x.type===type && x.name===opt.name);
            
            if(qty === 0 && existingIdx >= 0) {
              chosen.splice(existingIdx, 1);
            } else if(qty > 0) {
              if(existingIdx >= 0) {
                chosen[existingIdx].quantity = qty;
              } else {
                chosen.push({ 
                  type, 
                  name: opt.name, 
                  price: opt.price, 
                  img: opt.img,
                  quantity: qty 
                });
              }
            }
            updateTotalAndHighlight();
          });
        } else {
          card.innerHTML = `
            <img src="${opt.img||''}" alt="${escapeHtml(opt.name)}">
            <div class="title">${escapeHtml(opt.name)}</div>
            <div class="price">${opt.price} üí∞</div>
            <div class="row"><label><input type="checkbox"></label></div>
          `;
          
          card.addEventListener('click', (ev)=>{
            if(ev.target.tagName === 'INPUT') return;
            const cb = card.querySelector('input[type=checkbox]');
            cb.checked = !cb.checked;
            if(cb.checked) {
              chosen.push({type, name: opt.name, price: opt.price, img: opt.img, quantity: 1});
            } else {
              const idx = chosen.findIndex(x=>x.type===type && x.name===opt.name);
              if(idx>=0) chosen.splice(idx,1);
            }
            updateTotalAndHighlight();
          });
        }
        grid.appendChild(card);
      });
    });
  }
  attachArea.appendChild(grid);
  updateTotalAndHighlight();

  // add to cart
  el('pv_add_to_cart').onclick = ()=>{
    if(!currentUser){ alert('–í–æ–π–¥–∏—Ç–µ –¥–ª—è –ø–æ–∫—É–ø–∫–∏'); return; }
    cart.push({ 
      id:p.id, 
      name:p.name, 
      price:p.price, 
      qty:1, 
      attachments: chosen.map(x=>({
        type: x.type,
        name: x.name, 
        price: x.price, 
        img: x.img,
        quantity: x.quantity || 1
      })) 
    });
    updateCartUI(); 
    hideModal('productModalView'); 
    alert('–¢–æ–≤–∞—Ä –¥–æ–±–∞–≤–ª–µ–Ω –≤ –∫–æ—Ä–∑–∏–Ω—É');
  };
  el('pv_close').onclick = ()=> hideModal('productModalView');

  showModal('productModalView');
}

/* -------------------------
   Modal helpers - –ò–°–ü–†–ê–í–õ–ï–ù–ù–´–ï
   ------------------------- */
function showModal(id){ 
  closeAllPanels(); // –°–Ω–∞—á–∞–ª–∞ –∑–∞–∫—Ä—ã–≤–∞–µ–º –≤—Å—ë
  document.getElementById('overlay').style.display='block'; 
  el(id).style.display='block'; 
}

function hideModal(id){ 
  if(el(id)) el(id).style.display='none'; 
  checkOverlayVisibility();
}

// –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω—É–∂–Ω–æ –ª–∏ –ø–æ–∫–∞–∑—ã–≤–∞—Ç—å –æ–≤–µ—Ä–ª–µ–π
function checkOverlayVisibility() {
  const overlay = document.getElementById('overlay');
  const anyPanelOpen = ['cartPanel','loginPanel','myOrdersPanel','sellerPanel'].some(id => 
    el(id).style.display === 'block'
  );
  const anyModalOpen = ['productModalView','productModalEdit'].some(id => 
    el(id).style.display === 'block'
  );
  
  if (anyPanelOpen || anyModalOpen) {
    overlay.style.display = 'block';
  } else {
    overlay.style.display = 'none';
  }
}

el('closeProductView').addEventListener('click', ()=> hideModal('productModalView'));
el('closeProductEdit').addEventListener('click', ()=> hideModal('productModalEdit'));

/* -------------------------
   Cart UI
   ------------------------- */
function updateCartUI(){
  const box = el('cartItems'); box.innerHTML=''; let total=0;
  cart.forEach((it, idx)=>{
    const row = document.createElement('div'); row.className='list-item';
    const left = document.createElement('div'); 
    let attachText = '';
    if(it.attachments && it.attachments.length) {
      attachText = it.attachments.map(a => {
        if(a.quantity > 1) {
          return `${a.name} √ó${a.quantity} (${a.price * a.quantity}üí∞)`;
        } else {
          return `${a.name} (${a.price}üí∞)`;
        }
      }).join(', ');
    }
    left.innerHTML = `<div><b>${escapeHtml(it.name)}</b></div><div class="muted">${attachText}</div>`;
    const right = document.createElement('div'); right.innerHTML = `<div>${it.price} üí∞ √ó <input type="number" value="${it.qty}" min="1" style="width:60px" data-idx="${idx}"></div><div style="margin-top:6px"><button data-rem="${idx}" class="ghost">‚ùå</button></div>`;
    row.appendChild(left); row.appendChild(right); box.appendChild(row);
    total += it.price * (it.qty||1) + (it.attachments? it.attachments.reduce((s,a)=>s + (a.price * (a.quantity || 1)),0):0);
  });
  el('cartTotal').textContent = total;
  box.querySelectorAll('input[type=number]').forEach(inp=> inp.addEventListener('change', e=>{ const i = parseInt(e.target.dataset.idx); cart[i].qty = Math.max(1, parseInt(e.target.value)||1); updateCartUI(); }));
  box.querySelectorAll('button[data-rem]').forEach(btn=> btn.addEventListener('click', ()=>{ cart.splice(parseInt(btn.dataset.rem),1); updateCartUI(); }));
}

el('btnCheckout').addEventListener('click', async ()=> {
  if(!currentUser){ alert('–í–æ–π–¥–∏—Ç–µ'); return; }
  if(cart.length===0) return alert('–ö–æ—Ä–∑–∏–Ω–∞ –ø—É—Å—Ç–∞');
  
  users = await loadJSON(KEY_USERS, users);
  users[currentUser] = users[currentUser] || { password:'', orders:[] };
  users[currentUser].orders = users[currentUser].orders || [];
  
  const order = {
    id: Date.now(),
    date: new Date().toLocaleString(),
    items: JSON.parse(JSON.stringify(cart)),
    status: 'pending',
    total: cart.reduce((s,it)=>s + it.price * (it.qty||1) + (it.attachments? it.attachments.reduce((sa,a)=>sa + (a.price * (a.quantity || 1)),0):0),0)
  };
  
  users[currentUser].orders.push(order);
  const saved = await saveJSON(KEY_USERS, users);
  if(saved) {
    alert('–ó–∞—è–≤–∫–∞ —Å–æ–∑–¥–∞–Ω–∞! ID: ' + order.id);
    cart = []; 
    updateCartUI(); 
    closeAllPanels();
  } else {
    alert('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –∑–∞—è–≤–∫–∏');
  }
});

/* -------------------------
   Auth - –° –°–û–•–†–ê–ù–ï–ù–ò–ï–ú –°–ï–°–°–ò–ò
   ------------------------- */
el('btnRegister').addEventListener('click', async ()=> {
  const u = el('username').value.trim(), p = el('password').value.trim();
  if(!u||!p) return alert('–í–≤–µ–¥–∏—Ç–µ –ª–æ–≥–∏–Ω –∏ –ø–∞—Ä–æ–ª—å');
  users = await loadJSON(KEY_USERS, users);
  if(users[u]) return alert('–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç');
  users[u] = { password: p, orders: [] };
  const saved = await saveJSON(KEY_USERS, users);
  if(saved) {
    alert('–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–æ');
    currentUser = u;
    localStorage.setItem(KEY_CURRENT_USER, u);
    updateUserUI();
    closeAllPanels();
  } else {
    alert('–û—à–∏–±–∫–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏');
  }
});

el('btnSignIn').addEventListener('click', async ()=> {
  const u = el('username').value.trim(), p = el('password').value.trim();
  users = await loadJSON(KEY_USERS, users);
  if(!users[u] || users[u].password !== p) return alert('–ù–µ–≤–µ—Ä–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ');
  currentUser = u;
  localStorage.setItem(KEY_CURRENT_USER, u);
  updateUserUI();
  closeAllPanels();
  alert('–í—Ö–æ–¥ –≤—ã–ø–æ–ª–Ω–µ–Ω');
});

function updateUserUI() {
  if(currentUser) {
    el('btnLogin').style.display = 'none';
    el('btnMyOrders').style.display = 'inline-block';
    el('username').value = currentUser;
  } else {
    el('btnLogin').style.display = 'inline-block';
    el('btnMyOrders').style.display = 'none';
  }
}

/* -------------------------
   My orders - –ë–ï–ó –ú–ò–ì–ê–ù–ò–Ø
   ------------------------- */
async function renderMyOrders(){
  if(!currentUser) return;
  const box = el('myOrdersList'); 
  box.innerHTML = '<div class="muted">–ó–∞–≥—Ä—É–∑–∫–∞...</div>';
  
  users = await loadJSON(KEY_USERS, users);
  const orders = (users[currentUser] && users[currentUser].orders) || [];
  
  if(orders.length===0){ 
    box.innerHTML = '<div class="muted">–ó–∞–∫–∞–∑–æ–≤ –Ω–µ—Ç</div>'; 
    return; 
  }
  
  // –°–æ—Ä—Ç–∏—Ä—É–µ–º –∑–∞–∫–∞–∑—ã –ø–æ –¥–∞—Ç–µ (–Ω–æ–≤—ã–µ —Å–≤–µ—Ä—Ö—É)
  orders.sort((a,b) => b.id - a.id);
  
  let html = '';
  for(const o of orders) {
    // –ó–∞–≥—Ä—É–∂–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –¥–ª—è —ç—Ç–æ–≥–æ –∑–∞–∫–∞–∑–∞
    const chatMsg = await loadChat(currentUser, o.id);
    
    let itemsHtml = '';
    o.items.forEach(item => {
      let attachmentsHtml = '';
      if(item.attachments && item.attachments.length > 0) {
        attachmentsHtml = `<div class="item-attachments">${item.attachments.map(att => 
          `+ ${att.name}${att.quantity > 1 ? ` √ó${att.quantity}` : ''} (${att.price * (att.quantity || 1)}üí∞)`
        ).join('<br>')}</div>`;
      }
      itemsHtml += `<div class="order-item">
        <span class="item-name">${escapeHtml(item.name)}</span>
        <span class="item-qty">√ó${item.qty}</span>
        ${attachmentsHtml}
      </div>`;
    });
    
    html += `
      <div class="list-item">
        <div style="flex:1">
          <b>–ó–∞—è–≤–∫–∞ #${o.id}</b> 
          <div class="muted">${o.date}</div>
          <div class="order-details">
            ${itemsHtml}
          </div>
          <div style="margin-top:6px"><b>–ò—Ç–æ–≥–æ: ${o.total} üí∞</b></div>
          <div class="muted">–°—Ç–∞—Ç—É—Å: ${o.status}</div>
          ${chatMsg ? `
            <div class="message-notification">
              <strong>üì® –°–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç –ø—Ä–æ–¥–∞–≤—Ü–∞:</strong><br>
              ${escapeHtml(chatMsg)}
            </div>
          ` : ''}
        </div>
        <div>
          <button class="ghost" onclick="cancelOrder(${o.id})">–û—Ç–º–µ–Ω–∏—Ç—å</button>
        </div>
      </div>
    `;
  }
  
  box.innerHTML = html;
}

async function cancelOrder(orderId) {
  if(!confirm('–û—Ç–º–µ–Ω–∏—Ç—å —ç—Ç—É –∑–∞—è–≤–∫—É?')) return;
  
  users = await loadJSON(KEY_USERS, users);
  users[currentUser].orders = users[currentUser].orders.filter(o => o.id !== orderId);
  const saved = await saveJSON(KEY_USERS, users);
  if(saved) {
    renderMyOrders();
  } else {
    alert('–û—à–∏–±–∫–∞ –æ—Ç–º–µ–Ω—ã –∑–∞—è–≤–∫–∏');
  }
}

/* -------------------------
   Seller panel - –ü–ê–†–û–õ–¨ –ò–ó –ë–î
   ------------------------- */
el('btnSellerLogin').addEventListener('click', async ()=> {
  const pass = el('sellerPass').value;
  // –ó–∞–≥—Ä—É–∂–∞–µ–º –∞–∫—Ç—É–∞–ª—å–Ω—É—é –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é
  sellerConfig = await loadJSON(KEY_SELLER_CONFIG, DEFAULT_CONFIG);
  
  if(pass === sellerConfig.sellerPassword) {
    el('sellerLoginArea').style.display = 'none';
    el('sellerArea').style.display = 'block';
    renderSellerOrders();
  } else {
    alert('–ù–µ–≤–µ—Ä–Ω—ã–π –ø–∞—Ä–æ–ª—å –ø—Ä–æ–¥–∞–≤—Ü–∞!');
  }
});

// –¢–∞–±—ã –ø—Ä–æ–¥–∞–≤—Ü–∞
el('tabOrders').addEventListener('click', ()=> showSellerTab('orders'));
el('tabProducts').addEventListener('click', ()=> { showSellerTab('products'); renderSellerProducts(); });
el('tabCategories').addEventListener('click', ()=> { showSellerTab('categories'); renderSellerCategories(); });

function showSellerTab(name){
  el('sellerOrdersSection').style.display = name==='orders' ? 'block' : 'none';
  el('sellerProductsSection').style.display = name==='products' ? 'block' : 'none';
  el('sellerCategoriesSection').style.display = name==='categories' ? 'block' : 'none';
  
  // –û–±–Ω–æ–≤–ª—è–µ–º –∞–∫—Ç–∏–≤–Ω—ã–π —Ç–∞–±
  ['tabOrders','tabProducts','tabCategories'].forEach(tab => {
    el(tab).classList.remove('active');
  });
  el('tab' + name.charAt(0).toUpperCase() + name.slice(1)).classList.add('active');
}

/* -------------------------
   Seller orders - –ë–ï–ó –ú–ò–ì–ê–ù–ò–Ø
   ------------------------- */
async function renderSellerOrders(){
  const out = el('ordersList'); 
  out.innerHTML = '<div class="muted">–ó–∞–≥—Ä—É–∑–∫–∞...</div>';
  
  users = await loadJSON(KEY_USERS, users);
  const allOrders = [];
  Object.keys(users).forEach(u=>{
    (users[u].orders || []).forEach(o=>{
      allOrders.push({...o, user:u});
    });
  });
  
  if(allOrders.length === 0) {
    out.innerHTML = '<div class="muted">–ù–µ—Ç –∑–∞—è–≤–æ–∫</div>';
    return;
  }
  
  // –°–æ—Ä—Ç–∏—Ä—É–µ–º –ø–æ –¥–∞—Ç–µ (–Ω–æ–≤—ã–µ —Å–≤–µ—Ä—Ö—É)
  allOrders.sort((a,b) => b.id - a.id);
  
  let html = '';
  for(const o of allOrders) {
    // –ó–∞–≥—Ä—É–∂–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –¥–ª—è —ç—Ç–æ–≥–æ –∑–∞–∫–∞–∑–∞
    const chatMsg = await loadChat(o.user, o.id);
    
    let itemsHtml = '';
    o.items.forEach(item => {
      let attachmentsHtml = '';
      if(item.attachments && item.attachments.length > 0) {
        attachmentsHtml = `<div class="item-attachments">${item.attachments.map(att => 
          `+ ${att.name}${att.quantity > 1 ? ` √ó${att.quantity}` : ''} (${att.price * (att.quantity || 1)}üí∞)`
        ).join('<br>')}</div>`;
      }
      itemsHtml += `<div class="order-item">
        <span class="item-name">${escapeHtml(item.name)}</span>
        <span class="item-qty">√ó${item.qty}</span>
        ${attachmentsHtml}
      </div>`;
    });
    
    html += `
      <div class="list-item">
        <div style="flex:1">
          <b>${escapeHtml(o.user)}</b> ‚Äî –ó–∞—è–≤–∫–∞ #${o.id}
          <div class="muted">${o.date}</div>
          <div class="order-details">
            ${itemsHtml}
          </div>
          <div style="margin-top:6px"><b>–ò—Ç–æ–≥–æ: ${o.total} üí∞</b></div>
          <div class="muted">–°—Ç–∞—Ç—É—Å: ${o.status}</div>
          ${chatMsg ? `
            <div class="chat-note">
              <strong>üì® –í–∞—à–µ —Å–æ–æ–±—â–µ–Ω–∏–µ:</strong><br>
              ${escapeHtml(chatMsg)}
            </div>
          ` : ''}
        </div>
        <div style="display:flex;flex-direction:column;gap:6px;min-width:120px">
          <select class="status-select" data-user="${o.user}" data-id="${o.id}" style="background:#080808;color:#fff;border:1px solid #333;border-radius:4px;padding:4px">
            <option value="pending" ${o.status==='pending'?'selected':''}>–û–∂–∏–¥–∞–Ω–∏–µ</option>
            <option value="processing" ${o.status==='processing'?'selected':''}>–í –æ–±—Ä–∞–±–æ—Ç–∫–µ</option>
            <option value="completed" ${o.status==='completed'?'selected':''}>–í—ã–ø–æ–ª–Ω–µ–Ω</option>
            <option value="cancelled" ${o.status==='cancelled'?'selected':''}>–û—Ç–º–µ–Ω–µ–Ω</option>
          </select>
          <button class="btn" onclick="saveOrderStatus('${o.user}', ${o.id}, this)">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
          <button class="ghost" onclick="openSellerChat('${o.user}', ${o.id})">üí¨ –ù–∞–ø–∏—Å–∞—Ç—å</button>
          <button class="ghost" onclick="deleteOrder('${o.user}', ${o.id})">üóë –£–¥–∞–ª–∏—Ç—å</button>
        </div>
      </div>
    `;
  }
  
  out.innerHTML = html;
}

async function saveOrderStatus(user, orderId, btn) {
  const row = btn.closest('.list-item');
  const statusSelect = row.querySelector('.status-select');
  const newStatus = statusSelect.value;
  
  users = await loadJSON(KEY_USERS, users);
  const order = users[user].orders.find(o => o.id == orderId);
  if(order) {
    order.status = newStatus;
    const saved = await saveJSON(KEY_USERS, users);
    if(saved) {
      alert('–°—Ç–∞—Ç—É—Å –æ–±–Ω–æ–≤–ª–µ–Ω');
    } else {
      alert('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è');
    }
  }
}

async function deleteOrder(user, orderId) {
  if(!confirm('–£–¥–∞–ª–∏—Ç—å —ç—Ç—É –∑–∞—è–≤–∫—É?')) return;
  
  users = await loadJSON(KEY_USERS, users);
  users[user].orders = users[user].orders.filter(o => o.id != orderId);
  const saved = await saveJSON(KEY_USERS, users);
  if(saved) {
    renderSellerOrders();
  } else {
    alert('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è');
  }
}

/* -------------------------
   Seller chat
   ------------------------- */
function openSellerChat(user, orderId) {
  const modal = document.createElement('div');
  modal.className = 'modal';
  modal.style.width = '500px';
  modal.innerHTML = `
    <button class="close" onclick="closeAllPanels()">‚úï</button>
    <h2>üí¨ –ß–∞—Ç —Å ${escapeHtml(user)}</h2>
    <div class="muted">–ó–∞—è–≤–∫–∞ #${orderId}</div>
    
    <div id="sellerChatHistory" style="margin:12px 0; padding:12px; background:rgba(255,255,255,0.05); border-radius:8px; min-height:100px; max-height:200px; overflow-y:auto">
      <div class="muted">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
    </div>
    
    <textarea id="sellerChatMessage" placeholder="–í–≤–µ–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –¥–ª—è –ø–æ–∫—É–ø–∞—Ç–µ–ª—è..." style="width:100%; min-height:80px; margin-bottom:8px"></textarea>
    <div class="chat-note">–°–æ–æ–±—â–µ–Ω–∏–µ –±—É–¥–µ—Ç –≤–∏–¥–Ω–æ –ø–æ–∫—É–ø–∞—Ç–µ–ª—é –≤ —Ä–∞–∑–¥–µ–ª–µ "–ú–æ–∏ –∑–∞—è–≤–∫–∏"</div>
    
    <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:12px">
      <button onclick="sendSellerMessage('${user}', ${orderId})" class="btn">üì§ –û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
      <button class="ghost" onclick="closeAllPanels()">–û—Ç–º–µ–Ω–∞</button>
    </div>
  `;
  
  document.body.appendChild(modal);
  showModal('sellerChat');
  
  // –ó–∞–≥—Ä—É–∑–∫–∞ —Ç–µ–∫—É—â–µ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è
  loadChat(user, orderId).then(msg => {
    const history = document.getElementById('sellerChatHistory');
    if(msg) {
      history.innerHTML = `
        <div style="margin-bottom:8px"><strong>–¢–µ–∫—É—â–µ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ:</strong></div>
        <div style="background:rgba(255,152,0,0.1); padding:8px; border-radius:6px; border-left:3px solid var(--accent)">
          ${escapeHtml(msg)}
        </div>
      `;
    } else {
      history.innerHTML = '<div class="muted">–°–æ–æ–±—â–µ–Ω–∏–π –µ—â–µ –Ω–µ—Ç</div>';
    }
  });
}

async function sendSellerMessage(user, orderId) {
  const message = document.getElementById('sellerChatMessage').value.trim();
  if(!message) return alert('–í–≤–µ–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ');
  
  const saved = await saveChat(user, orderId, message);
  if(saved) {
    alert('–°–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ –ø–æ–∫—É–ø–∞—Ç–µ–ª—é!');
    closeAllPanels();
    renderSellerOrders();
  } else {
    alert('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏—è');
  }
}

/* -------------------------
   Seller products editor - –ò–°–ü–†–ê–í–õ–ï–ù–ù–´–ô
   ------------------------- */
async function renderSellerProducts(){
  const wrap = el('productsEditorList'); 
  wrap.innerHTML = '<div class="muted">–ó–∞–≥—Ä—É–∑–∫–∞...</div>';
  
  let html = '';
  products.forEach(p=>{
    html += `
      <div class="list-item">
        <div><b>${escapeHtml(p.name)}</b><div class="muted">${getCatTitle(p.category)} ${p.subcategory?'/ '+getSubTitle(p.category,p.subcategory):''} ‚Äî ${p.price}üí∞</div></div>
        <div style="display:flex;gap:6px">
          <button class="ghost" onclick="openProductEdit(${p.id})">‚úè</button>
          <button class="ghost" onclick="deleteProduct(${p.id})">‚ùå</button>
        </div>
      </div>
    `;
  });
  
  wrap.innerHTML = html || '<div class="muted">–¢–æ–≤–∞—Ä–æ–≤ –Ω–µ—Ç</div>';
}

el('btnNewProduct').addEventListener('click', ()=> openProductEdit(null));

async function deleteProduct(productId) {
  if(!confirm('–£–¥–∞–ª–∏—Ç—å —ç—Ç–æ—Ç —Ç–æ–≤–∞—Ä?')) return;
  
  products = products.filter(x=>x.id!==productId); 
  const saved = await saveJSON(KEY_PRODUCTS, products);
  if(saved) {
    renderProducts(); 
    renderSellerProducts();
  } else {
    alert('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è —Ç–æ–≤–∞—Ä–∞');
  }
}

/* -------------------------
   Product edit modal - –ò–°–ü–†–ê–í–õ–ï–ù–ù–´–ô
   ------------------------- */
function openProductEdit(editId){
  const modal = el('productModalEdit'); 
  const form = el('productEditForm'); 
  form.innerHTML='';
  
  let item = { 
    id:null, 
    name:'', 
    price:0, 
    img:'', 
    category: cats.mains[0]?.id || '', 
    subcategory:'', 
    caliber:'', 
    description:'', 
    attachments:{} 
  };
  
  if(editId){
    const found = products.find(x=>x.id===editId); 
    if(found) item = JSON.parse(JSON.stringify(found));
    el('editTitle').textContent = '–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —Ç–æ–≤–∞—Ä';
  } else {
    el('editTitle').textContent = '–î–æ–±–∞–≤–∏—Ç—å —Ç–æ–≤–∞—Ä';
  }

  form.innerHTML = `
    <div class="form-row">
      <div class="form-col"><label>–ù–∞–∑–≤–∞–Ω–∏–µ</label><input id="e_name" value="${escapeHtml(item.name)}"></div>
      <div class="form-col"><label>–¶–µ–Ω–∞</label><input id="e_price" type="number" value="${item.price}"></div>
    </div>
    <div class="form-row" style="margin-top:8px">
      <div class="form-col"><label>–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ (URL)</label><input id="e_img" value="${escapeHtml(item.img)}"></div>
      <div class="form-col"><label>–ö–∞–ª–∏–±—Ä</label><input id="e_caliber" value="${escapeHtml(item.caliber)}"></div>
    </div>
    <div style="margin-top:8px"><label>–û–ø–∏—Å–∞–Ω–∏–µ</label><textarea id="e_desc">${escapeHtml(item.description||'')}</textarea></div>
    <div class="form-row" style="margin-top:8px">
      <div class="form-col"><label>–ì–ª–∞–≤–Ω–∞—è –∫–∞—Ç–µ–≥–æ—Ä–∏—è</label><select id="e_cat"></select></div>
      <div class="form-col"><label>–ü–æ–¥–∫–∞—Ç–µ–≥–æ—Ä–∏—è</label><select id="e_subcat"><option value="">‚Äî</option></select></div>
    </div>

    <div style="margin-top:10px"><strong>–û–±–≤–µ—Å—ã</strong>
      <div id="e_attach_container" style="margin-top:8px"></div>
      <div style="display:flex;gap:8px;margin-top:8px">
        <button id="btnAddAttachRow" type="button" class="btn">–î–æ–±–∞–≤–∏—Ç—å –æ–±–≤–µ—Å</button>
      </div>
      <div class="small-muted">–î–ª—è –∫–∞–∂–¥–æ–≥–æ –æ–±–≤–µ—Å–∞ —É–∫–∞–∂–∏ –Ω–∞–∑–≤–∞–Ω–∏–µ, —Ü–µ–Ω—É, URL –∫–∞—Ä—Ç–∏–Ω–∫–∏ –∏ –≤—ã–±–µ—Ä–∏ —Ç–∏–ø –∏–∑ —Å–ø–∏—Å–∫–∞. –ü–æ—Å—Ç–∞–≤—å –≥–∞–ª–æ—á–∫—É "–ö–æ–ª–∏—á–µ—Å—Ç–≤–µ–Ω–Ω—ã–π" –µ—Å–ª–∏ –æ–±–≤–µ—Å –ø—Ä–æ–¥–∞—ë—Ç—Å—è —à—Ç—É–∫–∞–º–∏.</div>
    </div>

    <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:12px">
      <button id="e_save" type="button" class="btn">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
      <button id="e_cancel" type="button" class="ghost">–û—Ç–º–µ–Ω–∞</button>
    </div>
  `;

  // fill categories & subcats
  const selCat = el('e_cat'); selCat.innerHTML=''; 
  cats.mains.forEach(c=>{ 
    const o=document.createElement('option'); 
    o.value=c.id; o.textContent=c.title; 
    if(c.id===item.category) o.selected=true; 
    selCat.appendChild(o); 
  });
  
  populateEditSubcats(item.category, item.subcategory);
  selCat.onchange = ()=> populateEditSubcats(selCat.value, '');

  // fill existing attachments as rows
  const attachContainer = el('e_attach_container');
  attachContainer.innerHTML = '';
  
  if(item.attachments){
    Object.keys(item.attachments).forEach(type=>{
      (item.attachments[type]||[]).forEach(opt=>{
        createAttachRow(attachContainer, type, opt.name, opt.price, opt.img, opt.quantity || false);
      });
    });
  }

  // add row click
  el('btnAddAttachRow').addEventListener('click', ()=> {
    createAttachRow(attachContainer, cats.attachTypes[0]||'', '', 0, '', false);
  });

  el('e_cancel').onclick = ()=> hideModal('productModalEdit');
  el('e_save').onclick = async ()=>{
    const name = el('e_name').value.trim(); 
    const price = parseFloat(el('e_price').value)||0; 
    const img = el('e_img').value.trim();
    const caliber = el('e_caliber').value.trim(); 
    const desc = el('e_desc').value.trim();
    const category = el('e_cat').value; 
    const subcategory = el('e_subcat').value || '';
    
    if(!name) return alert('–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ');
    
    // collect attach rows and convert to attachments object grouped by type
    const attachments = {};
    attachContainer.querySelectorAll('.attach-row').forEach(r=>{
      const aname = r.querySelector('.a_name').value.trim();
      const aprice = parseFloat(r.querySelector('.a_price').value) || 0;
      const aimg = r.querySelector('.a_img').value.trim();
      const atype = r.querySelector('.a_type').value || '';
      const aquantity = r.querySelector('.a_quantity').checked;
      
      if(!aname) return; // skip empty
      attachments[atype] = attachments[atype] || [];
      attachments[atype].push({ 
        name: aname, 
        price: aprice, 
        img: aimg,
        quantity: aquantity
      });
    });

    if(editId){
      const idx = products.findIndex(x=>x.id===editId);
      if(idx>=0) products[idx] = { id: editId, name, price, img, category, subcategory, caliber, description: desc, attachments };
    } else {
      const newid = products.reduce((m,x)=>x.id > m ? x.id : m, 0) + 1;
      products.push({ id: newid, name, price, img, category, subcategory, caliber, description: desc, attachments });
    }
    
    const saved = await saveJSON(KEY_PRODUCTS, products);
    if(saved) {
      renderProducts(); 
      renderSellerProducts(); 
      hideModal('productModalEdit');
      alert('–¢–æ–≤–∞—Ä —Å–æ—Ö—Ä–∞–Ω–µ–Ω!');
    } else {
      alert('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —Ç–æ–≤–∞—Ä–∞');
    }
  };

  showModal('productModalEdit');
}

/* create attach row for edit modal */
function createAttachRow(container, type='', name='', price=0, img='', quantity=false){
  const div = document.createElement('div');
  div.className = 'attach-row';
  
  const sel = document.createElement('select'); 
  sel.className='a_type';
  cats.attachTypes.forEach(t=>{ 
    const o=document.createElement('option'); 
    o.value=t; o.textContent=t; 
    if(t===type) o.selected=true; 
    sel.appendChild(o); 
  });
  
  const inQuantity = document.createElement('input');
  inQuantity.type = 'checkbox';
  inQuantity.className = 'a_quantity';
  inQuantity.checked = quantity;
  inQuantity.title = '–ü—Ä–æ–¥–∞–≤–∞—Ç—å –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ–º';
  inQuantity.style.width = '20px';
  
  const inName = document.createElement('input'); 
  inName.placeholder='–ù–∞–∑–≤–∞–Ω–∏–µ'; 
  inName.className='a_name'; 
  inName.type='text'; 
  inName.value = name;
  
  const inPrice = document.createElement('input'); 
  inPrice.placeholder='–¶–µ–Ω–∞'; 
  inPrice.className='a_price'; 
  inPrice.type='number'; 
  inPrice.value = price;
  
  const inImg = document.createElement('input'); 
  inImg.placeholder='URL –∫–∞—Ä—Ç–∏–Ω–∫–∏'; 
  inImg.className='a_img'; 
  inImg.type='text'; 
  inImg.value = img;
  
  const btnRem = document.createElement('button'); 
  btnRem.className='ghost'; 
  btnRem.textContent='‚úñ';
  btnRem.type = 'button';
  btnRem.addEventListener('click', ()=> div.remove());

  div.appendChild(inQuantity);
  div.appendChild(inName);
  inPrice.style.width='90px'; div.appendChild(inPrice);
  inImg.style.width='160px'; div.appendChild(inImg);
  sel.style.width='140px'; div.appendChild(sel);
  div.appendChild(btnRem);
  container.appendChild(div);
}

/* populate subcats in edit modal */
function populateEditSubcats(main, selected){
  const sel = el('e_subcat'); sel.innerHTML = '<option value="">‚Äî</option>';
  if(cats.subs[main]) cats.subs[main].forEach(s=>{ 
    const o=document.createElement('option'); 
    o.value=s.id; o.textContent=s.title; 
    if(s.id===selected) o.selected=true; 
    sel.appendChild(o); 
  });
}

// [–ö–æ–¥ –¥–ª—è renderSellerCategories –∏ –¥—Ä—É–≥–∏—Ö —Ñ—É–Ω–∫—Ü–∏–π –æ—Å—Ç–∞–µ—Ç—Å—è —Ç–∞–∫–∏–º –∂–µ...]

/* -------------------------
   Utils & Init
   ------------------------- */
function escapeHtml(unsafe){ if(!unsafe) return ''; return unsafe.toString().replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/"/g, "&quot;").replace(/'/g, "&#039;"); }
function getCatTitle(id){ const m = cats.mains.find(x=>x.id===id); return m?m.title:id; }
function getSubTitle(main,id){ if(!cats.subs[main]) return id; const s = cats.subs[main].find(x=>x.id===id); return s? s.title : id; }

async function initialRender(){
  await initializeData();
  renderCategoryFilter(); 
  renderSubcats(null); 
  renderProducts(); 
  updateUserUI();
  
  // panels hidden by default
  closeAllPanels();
}

// Initialize the app
initialRender();

/* Debug helpers */
window._debug = {
  products: () => products,
  users: () => users,
  cats: () => cats,
  currentUser: () => currentUser,
  sellerConfig: () => sellerConfig,
  closeAll: closeAllPanels
};
</script>
</body>

</html>

