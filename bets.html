<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>1X –ë–ê–†</title>
<style>
  :root{
    --accent:#ff9800;
    --bg:#850000;
    --panel-bg:rgba(18,18,18,0.96);
    --muted:#9aa;
    --card:#101010;
    --glass: rgba(255,255,255,0.03);
  }
  *{box-sizing:border-box}
  html,body{height:100%;margin:0;font-family:Inter,system-ui,Arial,sans-serif;background:url('https://i.imgur.com/Z1OWJQa.png') center/cover fixed;color:#fff}
  a{color:inherit}
  button,input,select,textarea{font:inherit}
  button{cursor:pointer}

  header{display:flex;justify-content:space-between;align-items:center;padding:12px 18px;background:linear-gradient(180deg,rgba(0,0,0,0.6),rgba(0,0,0,0.2));gap:12px;position:sticky;top:0;z-index:40}
  .brand{display:flex;flex-direction:column}
  .brand h1{margin:0;font-size:18px}
  .controls{display:flex;gap:8px}

  .container{padding:18px;max-width:1200px;margin:0 auto}
  
  .panel{background:var(--panel-bg);padding:16px;border-radius:10px;border:1px solid var(--glass);margin-bottom:18px}
  
  .btn{background:var(--accent);color:#000;padding:8px 16px;border-radius:8px;border:none;text-decoration:none;display:inline-block}
  .ghost{background:transparent;border:1px solid var(--glass);color:#fff;padding:6px 12px;border-radius:6px}
  
  .fight-card{background:var(--card);border:1px solid var(--glass);padding:16px;border-radius:8px;margin-bottom:12px}
  .fight-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:12px}
  .fighters{display:flex;justify-content:space-between;align-items:center;gap:20px;margin:20px 0}
  .fighter{text-align:center;flex:1;padding:12px;border:2px solid transparent;border-radius:8px;cursor:pointer;transition:all 0.2s}
  .fighter.selected{border-color:var(--accent);background:rgba(255,152,0,0.1)}
  .fighter.disabled{opacity:0.7;cursor:not-allowed}
  .fighter.coefficient{font-size:24px;font-weight:bold;color:var(--accent);margin:8px 0}
  .vs{font-size:18px;font-weight:bold;color:var(--muted)}
  
  .bet-form{display:none;margin-top:16px;padding:16px;background:rgba(255,255,255,0.05);border-radius:8px}
  .form-row{display:flex;gap:12px;margin-bottom:12px;align-items:center}
  input,select{width:100%;padding:8px;border-radius:6px;border:1px solid #222;background:#080808;color:#fff}
  
  .bets-list{margin-top:20px}
  .bet-item{background:var(--card);border:1px solid var(--glass);padding:12px;border-radius:8px;margin-bottom:8px;display:flex;justify-content:space-between;align-items:center}
  .bet-info{flex:1}
  .bet-amount{font-weight:bold;color:var(--accent)}
  .bet-status{padding:4px 8px;border-radius:4px;font-size:12px;margin-left:8px}
  .status-pending{background:rgba(255,193,7,0.2);color:#ffc107}
  .status-accepted{background:rgba(76,175,80,0.2);color:#4caf50}
  .status-rejected{background:rgba(244,67,54,0.2);color:#f44336}
  .status-won{background:rgba(76,175,80,0.3);color:#4caf50;font-weight:bold}
  .status-lost{background:rgba(244,67,54,0.3);color:#f44336}
  
  .tabs{display:flex;gap:8px;margin-bottom:16px;border-bottom:1px solid var(--glass);padding-bottom:8px}
  .tab{padding:8px 16px;border-radius:6px;cursor:pointer;border:none;background:transparent;color:var(--muted)}
  .tab.active{background:var(--accent);color:#000}
  
  .admin-section{margin-top:24px;padding-top:24px;border-top:1px solid var(--glass)}
  
  .small-muted{font-size:12px;color:var(--muted)}
  .muted{color:var(--muted)}
  
  .user-bet-info{margin-top:8px;padding:8px;background:rgba(255,152,0,0.1);border-radius:6px;border-left:3px solid var(--accent)}
</style>
</head>
<body>

<header>
  <div class="brand">
    <h1>üé≤1–• –ë–ê–†</h1>
    <div class="muted">–°—Ç–∞–≤–∫–∏ –Ω–∞ —Å–ø–æ—Ä—Ç - 1–• –ë–ê–†</div>
  </div>
  <div class="controls">
    <button id="btnLogin" class="ghost">–í—Ö–æ–¥</button>
    <button id="btnMyBets" class="ghost" style="display:none">–ú–æ–∏ —Å—Ç–∞–≤–∫–∏</button>
    <button id="btnAdmin" class="ghost">–ü–∞–Ω–µ–ª—å –∞–¥–º–∏–Ω–∞</button>
    <a href="index.html" class="btn">‚Üê –í –º–∞–≥–∞–∑–∏–Ω</a>
  </div>
</header>

<div class="container">
  <!-- –í–∫–ª–∞–¥–∫–∏ -->
  <div class="tabs">
    <button class="tab active" data-tab="fights">–ê–∫—Ç–∏–≤–Ω—ã–µ –±–æ–∏</button>
    <button class="tab" data-tab="mybets">–ú–æ–∏ —Å—Ç–∞–≤–∫–∏</button>
    <button class="tab" data-tab="history">–ò—Å—Ç–æ—Ä–∏—è –±–æ–µ–≤</button>
  </div>

  <!-- –ê–∫—Ç–∏–≤–Ω—ã–µ –±–æ–∏ -->
  <div id="fightsTab" class="tab-content">
    <div class="panel">
      <h3>üö® –ê–∫—Ç–∏–≤–Ω—ã–µ –±–æ–∏</h3>
      <div id="activeFightsList"></div>
    </div>
  </div>

  <!-- –ú–æ–∏ —Å—Ç–∞–≤–∫–∏ -->
  <div id="mybetsTab" class="tab-content" style="display:none">
    <div class="panel">
      <h3>üìä –ú–æ–∏ —Å—Ç–∞–≤–∫–∏</h3>
      <div id="myBetsList"></div>
    </div>
  </div>

  <!-- –ò—Å—Ç–æ—Ä–∏—è –±–æ–µ–≤ -->
  <div id="historyTab" class="tab-content" style="display:none">
    <div class="panel">
      <h3>üìú –ò—Å—Ç–æ—Ä–∏—è –±–æ–µ–≤</h3>
      <div id="finishedFightsList"></div>
    </div>
  </div>

  <!-- –ü–∞–Ω–µ–ª—å –∞–¥–º–∏–Ω–∞ -->
  <div id="adminPanel" class="panel" style="display:none">
    <h3>üëë –ü–∞–Ω–µ–ª—å –∞–¥–º–∏–Ω–∞ —Å—Ç–∞–≤–æ–∫</h3>
    
    <div id="betsAdminLoginArea">
      <input id="betsAdminPass" placeholder="–ü–∞—Ä–æ–ª—å –∞–¥–º–∏–Ω–∞ —Å—Ç–∞–≤–æ–∫" type="password" />
      <div style="display:flex;gap:8px;margin-top:8px">
        <button id="btnBetsAdminLogin" class="btn">–í–æ–π—Ç–∏</button>
        <button class="ghost" onclick="closeAdminPanel()">–ó–∞–∫—Ä—ã—Ç—å</button>
      </div>
    </div>

    <div id="betsAdminArea" style="display:none;margin-top:12px">
      <div class="tabs">
        <button class="tab active" data-admin-tab="manageFights">–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –±–æ—è–º–∏</button>
        <button class="tab" data-admin-tab="manageBets">–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å—Ç–∞–≤–∫–∞–º–∏</button>
        <button class="tab" data-admin-tab="createFight">–°–æ–∑–¥–∞—Ç—å –±–æ–π</button>
        <button class="ghost" onclick="closeAdminPanel()" style="margin-left:auto">–í—ã–π—Ç–∏</button>
      </div>

      <!-- –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –±–æ—è–º–∏ -->
      <div id="manageFightsTab" class="admin-tab-content">
        <h4>–ê–∫—Ç–∏–≤–Ω—ã–µ –±–æ–∏ –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è</h4>
        <div id="adminFightsList"></div>
      </div>

      <!-- –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å—Ç–∞–≤–∫–∞–º–∏ -->
      <div id="manageBetsTab" class="admin-tab-content" style="display:none">
        <h4>–í—Å–µ —Å—Ç–∞–≤–∫–∏</h4>
        <div id="allBetsList"></div>
      </div>

      <!-- –°–æ–∑–¥–∞–Ω–∏–µ –±–æ—è -->
      <div id="createFightTab" class="admin-tab-content" style="display:none">
        <h4>–°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—ã–π –±–æ–π</h4>
        <div class="form-row">
          <input type="text" id="newFightTitle" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ –±–æ—è (–Ω–∞–ø—Ä–∏–º–µ—Ä: –°—Ç–∞–ª–∫–µ—Ä vs –ú—É—Ç–∞–Ω—Ç)" style="flex:2">
          <input type="datetime-local" id="newFightDate" style="flex:1">
        </div>
        <div class="form-row">
          <input type="text" id="newFighter1" placeholder="–ë–æ–µ—Ü 1" style="flex:1">
          <input type="number" id="newCoefficient1" placeholder="–ö–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç" step="0.1" min="1" style="flex:1">
        </div>
        <div class="form-row">
          <input type="text" id="newFighter2" placeholder="–ë–æ–µ—Ü 2" style="flex:1">
          <input type="number" id="newCoefficient2" placeholder="–ö–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç" step="0.1" min="1" style="flex:1">
        </div>
        <button id="btnCreateFight" class="btn">–°–æ–∑–¥–∞—Ç—å –±–æ–π</button>
      </div>
    </div>
  </div>

  <!-- –§–æ—Ä–º–∞ –≤—Ö–æ–¥–∞ -->
  <div id="loginPanel" class="panel" style="display:none">
    <h3>–í—Ö–æ–¥ –≤ —Å–∏—Å—Ç–µ–º—É —Å—Ç–∞–≤–æ–∫</h3>
    <div class="form-row">
      <input id="betUsername" placeholder="–ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è">
      <input id="betPassword" placeholder="–ü–∞—Ä–æ–ª—å" type="password">
    </div>
    <div class="form-row">
      <button id="btnBetLogin" class="btn">–í–æ–π—Ç–∏</button>
      <button id="btnBetRegister" class="ghost">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</button>
      <button class="ghost" onclick="hideLogin()">–û—Ç–º–µ–Ω–∞</button>
    </div>
  </div>
</div>

<script>
// –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è JSONBin
const JSONBIN_BASE_URL = 'https://api.jsonbin.io/v3/b';
const JSONBIN_MASTER_KEY = '$2a$10$wTicXNpl/tYWk2p1tuUuC.w87l4en0x8a9e7STVUKFIfFQnaZFdLC';
const JSONBIN_ACCESS_KEY = '$2a$10$.twuYFU3QYQ1ZXPY.uyfB.7EryqBOUndWb3UbhjCfknwxJvHKo2LG';

const JSONBIN_IDS = {
  USERS: '6904f5d843b1c97be98eff3a',
  BETS: '690f1c1cae596e708f4c2532',
  FIGHTS: '690f5192d0ea881f40dbd74a',
  CONFIG: '69050c5343b1c97be98f23c9'
};

// –ö–ª—é—á–∏ localStorage
const KEY_CURRENT_USER = 'currentUser';
const KEY_USERS = 'users_v_final_v1';
const KEY_BETS = 'bets_v1';
const KEY_FIGHTS = 'fights_v1';
const KEY_SELLER_CONFIG = 'sellerConfig';

// –î–∞–Ω–Ω—ã–µ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
const DEFAULT_FIGHTS = [
  {
    id: 1,
    title: "–°—Ç–∞–ª–∫–µ—Ä –û–ø—ã—Ç–Ω—ã–π vs –ö—Ä–æ–≤–æ—Å–æ—Å",
    fighter1: { name: "–°—Ç–∞–ª–∫–µ—Ä –û–ø—ã—Ç–Ω—ã–π", coefficient: 1.8 },
    fighter2: { name: "–ö—Ä–æ–≤–æ—Å–æ—Å", coefficient: 2.2 },
    date: "2024-01-20 20:00",
    status: "active",
    winner: null
  },
  {
    id: 2,
    title: "–ù–æ–≤–∏—á–æ–∫ –ó–æ–Ω—ã vs –ü—Å–µ–≤–¥–æ—Å–æ–±–∞–∫–∞",
    fighter1: { name: "–ù–æ–≤–∏—á–æ–∫ –ó–æ–Ω—ã", coefficient: 2.5 },
    fighter2: { name: "–ü—Å–µ–≤–¥–æ—Å–æ–±–∞–∫–∞", coefficient: 1.6 },
    date: "2024-01-21 18:00",
    status: "active",
    winner: null
  }
];

const DEFAULT_BETS = [];
const DEFAULT_CONFIG = {
  sellerPassword: "admin123",
  betsAdminPassword: "bets123"
};

let currentUser = localStorage.getItem(KEY_CURRENT_USER);
let fights = [];
let bets = [];
let users = {};
let selectedFight = null;
let selectedFighter = null;

// –£—Ç–∏–ª–∏—Ç—ã
const el = id => document.getElementById(id);

// JSONBin —Ñ—É–Ω–∫—Ü–∏–∏
async function jsonbinFetch(binId) {
  const url = `${JSONBIN_BASE_URL}/${binId}/latest`;
  const headers = {
    'Content-Type': 'application/json',
    'X-Master-Key': JSONBIN_MASTER_KEY,
    'X-Access-Key': JSONBIN_ACCESS_KEY
  };
  
  try {
    const response = await fetch(url, { headers });
    if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
    const data = await response.json();
    return data.record;
  } catch (error) {
    console.error('JSONBin fetch error:', error);
    const fallback = localStorage.getItem(`fallback_${binId}`);
    return fallback ? JSON.parse(fallback) : null;
  }
}

async function jsonbinUpdate(binId, data) {
  const url = `${JSONBIN_BASE_URL}/${binId}`;
  const headers = {
    'Content-Type': 'application/json',
    'X-Master-Key': JSONBIN_MASTER_KEY,
    'X-Access-Key': JSONBIN_ACCESS_KEY
  };
  
  try {
    const response = await fetch(url, {
      method: 'PUT',
      headers: headers,
      body: JSON.stringify(data)
    });
    
    if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
    const result = await response.json();
    localStorage.setItem(`fallback_${binId}`, JSON.stringify(data));
    return result.record;
  } catch (error) {
    console.error('JSONBin update error:', error);
    localStorage.setItem(`fallback_${binId}`, JSON.stringify(data));
    return data;
  }
}

async function loadJSON(key, fallback) {
  try {
    let binId;
    switch(key) {
      case KEY_USERS: binId = JSONBIN_IDS.USERS; break;
      case KEY_BETS: binId = JSONBIN_IDS.BETS; break;
      case KEY_FIGHTS: binId = JSONBIN_IDS.FIGHTS; break;
      case KEY_SELLER_CONFIG: binId = JSONBIN_IDS.CONFIG; break;
      default: return JSON.parse(JSON.stringify(fallback));
    }
    
    const data = await jsonbinFetch(binId);
    return data || JSON.parse(JSON.stringify(fallback));
  } catch(e) {
    console.error('Load error:', e);
    return JSON.parse(JSON.stringify(fallback));
  }
}

async function saveJSON(key, val) {
  try {
    let binId;
    switch(key) {
      case KEY_USERS: binId = JSONBIN_IDS.USERS; break;
      case KEY_BETS: binId = JSONBIN_IDS.BETS; break;
      case KEY_FIGHTS: binId = JSONBIN_IDS.FIGHTS; break;
      case KEY_SELLER_CONFIG: binId = JSONBIN_IDS.CONFIG; break;
      default: return;
    }
    
    await jsonbinUpdate(binId, val);
    return true;
  } catch(e) {
    console.error('Save error:', e);
    return false;
  }
}

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö —Å –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω—ã–º —Å–æ–∑–¥–∞–Ω–∏–µ–º
async function initializeData() {
  console.log('Starting data initialization...');
  
  try {
    // –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ
    const [usersData, betsData, fightsData, configData] = await Promise.all([
      loadJSON(KEY_USERS, {}),
      loadJSON(KEY_BETS, DEFAULT_BETS),
      loadJSON(KEY_FIGHTS, DEFAULT_FIGHTS),
      loadJSON(KEY_SELLER_CONFIG, DEFAULT_CONFIG)
    ]);

    users = usersData;
    bets = betsData || DEFAULT_BETS;
    fights = fightsData || DEFAULT_FIGHTS;

    // –ï—Å–ª–∏ bins –ø—É—Å—Ç—ã–µ, —Å–æ–∑–¥–∞–µ–º –Ω–∞—á–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
    if (!fightsData || fightsData.length === 0) {
      console.log('Creating initial fights...');
      fights = DEFAULT_FIGHTS;
      await saveJSON(KEY_FIGHTS, fights);
    }

    if (!betsData || !Array.isArray(betsData)) {
      console.log('Creating initial bets...');
      bets = DEFAULT_BETS;
      await saveJSON(KEY_BETS, bets);
    }

    if (!configData) {
      console.log('Creating initial config...');
      await saveJSON(KEY_SELLER_CONFIG, DEFAULT_CONFIG);
    }

    console.log('Data loaded:', { fights, bets, users });

    updateUI();
    renderActiveFights();
    renderMyBets();
    renderFinishedFights();
    
  } catch (error) {
    console.error('Error initializing data:', error);
    // Fallback –Ω–∞ –ª–æ–∫–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
    fights = DEFAULT_FIGHTS;
    bets = DEFAULT_BETS;
    users = {};
    
    updateUI();
    renderActiveFights();
    renderMyBets();
    renderFinishedFights();
  }
}

// –§—É–Ω–∫—Ü–∏—è –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å—Ç–∞–≤–æ–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
function getUserBets(userId) {
  return bets.filter(bet => 
    bet.userId === userId && 
    (bet.status === 'pending' || bet.status === 'accepted')
  );
}

// –†–µ–Ω–¥–µ—Ä –∞–∫—Ç–∏–≤–Ω—ã—Ö –±–æ–µ–≤
function renderActiveFights() {
  const list = el('activeFightsList');
  const activeFights = fights.filter(f => f.status === 'active');
  
  console.log('Rendering active fights:', activeFights);
  
  if (activeFights.length === 0) {
    list.innerHTML = '<div class="muted">–ù–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö –±–æ–µ–≤</div>';
    return;
  }
  
  list.innerHTML = activeFights.map(fight => {
    const userBet = bets.find(bet => 
      bet.userId === currentUser && 
      bet.fightId === fight.id &&
      (bet.status === 'pending' || bet.status === 'accepted')
    );
    
    let userBetInfo = '';
    if (userBet) {
      userBetInfo = `
        <div class="user-bet-info">
          <strong>–í–∞—à–∞ —Å—Ç–∞–≤–∫–∞:</strong> ${userBet.amount}üí∞ –Ω–∞ ${userBet.fighterName}<br>
          <small>–°—Ç–∞—Ç—É—Å: ${getStatusText(userBet.status)}</small>
        </div>
      `;
    }
    
    return `
      <div class="fight-card" data-fight-id="${fight.id}">
        <div class="fight-header">
          <h4>${escapeHtml(fight.title)}</h4>
          <div class="muted">${new Date(fight.date).toLocaleString()}</div>
        </div>
        
        <div class="fighters">
          <div class="fighter ${userBet && userBet.fighter === 'fighter1' ? 'selected' : ''} 
               ${userBet ? 'disabled' : ''}" 
               data-fight-id="${fight.id}" data-fighter="fighter1">
            <div class="fighter-name">${escapeHtml(fight.fighter1.name)}</div>
            <div class="fighter coefficient">${fight.fighter1.coefficient}x</div>
            <div class="small-muted">–ö–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç</div>
            ${userBet && userBet.fighter === 'fighter1' ? '<div class="small-muted">‚úÖ –í–∞—à –≤—ã–±–æ—Ä</div>' : ''}
          </div>
          
          <div class="vs">VS</div>
          
          <div class="fighter ${userBet && userBet.fighter === 'fighter2' ? 'selected' : ''} 
               ${userBet ? 'disabled' : ''}" 
               data-fight-id="${fight.id}" data-fighter="fighter2">
            <div class="fighter-name">${escapeHtml(fight.fighter2.name)}</div>
            <div class="fighter coefficient">${fight.fighter2.coefficient}x</div>
            <div class="small-muted">–ö–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç</div>
            ${userBet && userBet.fighter === 'fighter2' ? '<div class="small-muted">‚úÖ –í–∞—à –≤—ã–±–æ—Ä</div>' : ''}
          </div>
        </div>
        
        ${userBetInfo}
        
        <div class="bet-form" id="betForm-${fight.id}">
          <div class="form-row">
            <input type="number" id="betAmount-${fight.id}" placeholder="–°—É–º–º–∞ —Å—Ç–∞–≤–∫–∏" min="1">
            <button class="btn" onclick="placeBet(${fight.id})">–°–¥–µ–ª–∞—Ç—å —Å—Ç–∞–≤–∫—É</button>
            <button class="ghost" onclick="cancelBet()">–û—Ç–º–µ–Ω–∞</button>
          </div>
          <div class="small-muted" id="potentialWin-${fight.id}"></div>
        </div>
      </div>
    `;
  }).join('');
  
  // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –∫–ª–∏–∫–æ–≤
  document.querySelectorAll('.fighter:not(.disabled)').forEach(fighterEl => {
    fighterEl.addEventListener('click', function() {
      if (!currentUser) {
        showLogin();
        return;
      }
      
      const fightId = parseInt(this.dataset.fightId);
      const existingBet = bets.find(bet => 
        bet.userId === currentUser && 
        bet.fightId === fightId &&
        (bet.status === 'pending' || bet.status === 'accepted')
      );
      
      if (existingBet) {
        alert('–í—ã —É–∂–µ —Å–¥–µ–ª–∞–ª–∏ —Å—Ç–∞–≤–∫—É –Ω–∞ —ç—Ç–æ—Ç –±–æ–π!');
        return;
      }
      
      const fighter = this.dataset.fighter;
      selectedFight = fights.find(f => f.id === fightId);
      selectedFighter = fighter;
      
      document.querySelectorAll('.fighter').forEach(f => f.classList.remove('selected'));
      document.querySelectorAll('.bet-form').forEach(f => f.style.display = 'none');
      
      this.classList.add('selected');
      const betForm = el(`betForm-${fightId}`);
      betForm.style.display = 'block';
      
      updatePotentialWin(fightId, fighter);
    });
  });
}

function updatePotentialWin(fightId, fighter) {
  const fight = fights.find(f => f.id === fightId);
  const amountInput = el(`betAmount-${fightId}`);
  const potentialWinEl = el(`potentialWin-${fightId}`);
  
  const updateWin = () => {
    const amount = parseFloat(amountInput.value) || 0;
    const coefficient = fighter === 'fighter1' ? fight.fighter1.coefficient : fight.fighter2.coefficient;
    const potentialWin = amount * coefficient;
    potentialWinEl.textContent = `–ü–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω—ã–π –≤—ã–∏–≥—Ä—ã—à: ${potentialWin.toFixed(2)} üí∞`;
  };
  
  amountInput.addEventListener('input', updateWin);
  updateWin();
}

// –†–∞–∑–º–µ—â–µ–Ω–∏–µ —Å—Ç–∞–≤–∫–∏
async function placeBet(fightId) {
  const amountInput = el(`betAmount-${fightId}`);
  const amount = parseFloat(amountInput.value);
  
  if (!amount || amount < 1) {
    alert('–í–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—É—é —Å—É–º–º—É —Å—Ç–∞–≤–∫–∏');
    return;
  }
  
  const fight = fights.find(f => f.id === fightId);
  const existingBet = bets.find(bet => 
    bet.userId === currentUser && 
    bet.fightId === fightId &&
    (bet.status === 'pending' || bet.status === 'accepted')
  );
  
  if (existingBet) {
    alert('–í—ã —É–∂–µ —Å–¥–µ–ª–∞–ª–∏ —Å—Ç–∞–≤–∫—É –Ω–∞ —ç—Ç–æ—Ç –±–æ–π!');
    return;
  }
  
  const coefficient = selectedFighter === 'fighter1' ? fight.fighter1.coefficient : fight.fighter2.coefficient;
  const fighterName = selectedFighter === 'fighter1' ? fight.fighter1.name : fight.fighter2.name;
  
  const newBet = {
    id: Date.now(),
    userId: currentUser,
    fightId: fightId,
    fighter: selectedFighter,
    fighterName: fighterName,
    amount: amount,
    coefficient: coefficient,
    potentialWin: amount * coefficient,
    status: 'pending',
    date: new Date().toLocaleString(),
    fightTitle: fight.title
  };
  
  bets.push(newBet);
  const saved = await saveJSON(KEY_BETS, bets);
  
  if (saved) {
    alert(`–°—Ç–∞–≤–∫–∞ –Ω–∞ ${fighterName} —Ä–∞–∑–º–µ—â–µ–Ω–∞! –°—É–º–º–∞: ${amount} üí∞`);
    cancelBet();
    renderActiveFights();
    renderMyBets();
  } else {
    alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Ä–∞–∑–º–µ—â–µ–Ω–∏–∏ —Å—Ç–∞–≤–∫–∏');
  }
}

function cancelBet() {
  selectedFight = null;
  selectedFighter = null;
  document.querySelectorAll('.fighter').forEach(f => f.classList.remove('selected'));
  document.querySelectorAll('.bet-form').forEach(f => f.style.display = 'none');
}

function renderMyBets() {
  const list = el('myBetsList');
  const myBets = bets.filter(bet => bet.userId === currentUser);
  
  if (myBets.length === 0) {
    list.innerHTML = '<div class="muted">–£ –≤–∞—Å –Ω–µ—Ç —Å—Ç–∞–≤–æ–∫</div>';
    return;
  }
  
  myBets.sort((a, b) => b.id - a.id);
  
  list.innerHTML = myBets.map(bet => {
    const fight = fights.find(f => f.id === bet.fightId);
    const statusClass = `status-${bet.status}`;
    const statusText = getStatusText(bet.status);
    
    let resultInfo = '';
    if (fight && fight.status === 'finished') {
      if (bet.fighter === fight.winner) {
        resultInfo = `<div class="bet-status status-won">üèÜ –í–´–ò–ì–†–´–®: ${bet.potentialWin} üí∞</div>`;
      } else {
        resultInfo = `<div class="bet-status status-lost">üí∏ –ü–†–û–ò–ì–†–´–®</div>`;
      }
    }
    
    return `
      <div class="bet-item">
        <div class="bet-info">
          <strong>${escapeHtml(bet.fightTitle)}</strong>
          <div class="muted">–°—Ç–∞–≤–∫–∞ –Ω–∞: ${escapeHtml(bet.fighterName)}</div>
          <div>–°—É–º–º–∞: <span class="bet-amount">${bet.amount} üí∞</span> (–∫–æ—ç—Ñ. ${bet.coefficient}x)</div>
          <div>–ü–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω—ã–π –≤—ã–∏–≥—Ä—ã—à: ${bet.potentialWin} üí∞</div>
        </div>
        <div>
          <div class="bet-status ${statusClass}">${statusText}</div>
          ${resultInfo}
          <div class="small-muted">${bet.date}</div>
        </div>
      </div>
    `;
  }).join('');
}

function renderFinishedFights() {
  const list = el('finishedFightsList');
  const finishedFights = fights.filter(f => f.status === 'finished');
  
  if (finishedFights.length === 0) {
    list.innerHTML = '<div class="muted">–ù–µ—Ç –∑–∞–≤–µ—Ä—à–µ–Ω–Ω—ã—Ö –±–æ–µ–≤</div>';
    return;
  }
  
  list.innerHTML = finishedFights.map(fight => {
    const winner = fight.winner === 'fighter1' ? fight.fighter1.name : fight.fighter2.name;
    return `
      <div class="fight-card">
        <div class="fight-header">
          <h4>${escapeHtml(fight.title)}</h4>
          <div class="muted">${new Date(fight.date).toLocaleString()}</div>
        </div>
        <div class="fighters">
          <div class="fighter ${fight.winner === 'fighter1' ? 'selected' : ''}">
            <div class="fighter-name">${escapeHtml(fight.fighter1.name)}</div>
            <div class="fighter coefficient">${fight.fighter1.coefficient}x</div>
          </div>
          <div class="vs">VS</div>
          <div class="fighter ${fight.winner === 'fighter2' ? 'selected' : ''}">
            <div class="fighter-name">${escapeHtml(fight.fighter2.name)}</div>
            <div class="fighter coefficient">${fight.fighter2.coefficient}x</div>
          </div>
        </div>
        <div style="text-align:center;margin-top:12px">
          <div class="bet-status status-won">üèÜ –ü–û–ë–ï–î–ò–¢–ï–õ–¨: ${escapeHtml(winner)}</div>
        </div>
      </div>
    `;
  }).join('');
}

// –ê–¥–º–∏–Ω —Ñ—É–Ω–∫—Ü–∏–∏
function closeAdminPanel() {
  el('adminPanel').style.display = 'none';
  el('betsAdminLoginArea').style.display = 'block';
  el('betsAdminArea').style.display = 'none';
  el('betsAdminPass').value = '';
}

el('btnBetsAdminLogin').addEventListener('click', async () => {
  const password = el('betsAdminPass').value;
  const config = await loadJSON(KEY_SELLER_CONFIG, DEFAULT_CONFIG);
  
  if (password === config.betsAdminPassword) {
    el('betsAdminLoginArea').style.display = 'none';
    el('betsAdminArea').style.display = 'block';
    renderAdminFights();
  } else {
    alert('–ù–µ–≤–µ—Ä–Ω—ã–π –ø–∞—Ä–æ–ª—å –∞–¥–º–∏–Ω–∞ —Å—Ç–∞–≤–æ–∫!');
  }
});

el('btnAdmin').addEventListener('click', () => {
  el('adminPanel').style.display = 'block';
  el('betsAdminLoginArea').style.display = 'block';
  el('betsAdminArea').style.display = 'none';
  el('betsAdminPass').value = '';
});

function renderAdminFights() {
  const list = el('adminFightsList');
  const activeFights = fights.filter(f => f.status === 'active');
  
  if (activeFights.length === 0) {
    list.innerHTML = '<div class="muted">–ù–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö –±–æ–µ–≤ –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è</div>';
    return;
  }
  
  list.innerHTML = activeFights.map(fight => `
    <div class="fight-card">
      <div class="fight-header">
        <h4>${escapeHtml(fight.title)}</h4>
        <div class="muted">${new Date(fight.date).toLocaleString()}</div>
      </div>
      <div class="fighters">
        <div class="fighter">
          <div class="fighter-name">${escapeHtml(fight.fighter1.name)}</div>
          <div class="coefficient">${fight.fighter1.coefficient}x</div>
        </div>
        <div class="vs">VS</div>
        <div class="fighter">
          <div class="fighter-name">${escapeHtml(fight.fighter2.name)}</div>
          <div class="coefficient">${fight.fighter2.coefficient}x</div>
        </div>
      </div>
      <div style="display:flex;gap:8px;margin-top:12px">
        <button class="btn" onclick="setWinner(${fight.id}, 'fighter1')">${escapeHtml(fight.fighter1.name)} –ø–æ–±–µ–¥–∏–ª</button>
        <button class="btn" onclick="setWinner(${fight.id}, 'fighter2')">${escapeHtml(fight.fighter2.name)} –ø–æ–±–µ–¥–∏–ª</button>
        <button class="ghost" onclick="cancelFight(${fight.id})">–û—Ç–º–µ–Ω–∏—Ç—å –±–æ–π</button>
      </div>
    </div>
  `).join('');
}

async function cancelFight(fightId) {
  if (!confirm('–û—Ç–º–µ–Ω–∏—Ç—å —ç—Ç–æ—Ç –±–æ–π? –í—Å–µ —Å—Ç–∞–≤–∫–∏ –±—É–¥—É—Ç –æ—Ç–∫–ª–æ–Ω–µ–Ω—ã.')) {
    return;
  }
  
  const fight = fights.find(f => f.id === fightId);
  if (!fight) return;
  
  fight.status = 'cancelled';
  
  // –û—Ç–∫–ª–æ–Ω—è–µ–º –≤—Å–µ —Å—Ç–∞–≤–∫–∏ –Ω–∞ —ç—Ç–æ—Ç –±–æ–π
  bets.forEach(bet => {
    if (bet.fightId === fightId && (bet.status === 'pending' || bet.status === 'accepted')) {
      bet.status = 'rejected';
    }
  });
  
  const [savedFights, savedBets] = await Promise.all([
    saveJSON(KEY_FIGHTS, fights),
    saveJSON(KEY_BETS, bets)
  ]);
  
  if (savedFights && savedBets) {
    alert('–ë–æ–π –æ—Ç–º–µ–Ω–µ–Ω! –í—Å–µ —Å—Ç–∞–≤–∫–∏ –æ—Ç–∫–ª–æ–Ω–µ–Ω—ã.');
    renderAdminFights();
    renderAllBets();
    renderActiveFights();
    renderMyBets();
    renderFinishedFights();
  }
}

async function setWinner(fightId, winner) {
  const fight = fights.find(f => f.id === fightId);
  const winnerName = winner === 'fighter1' ? fight.fighter1.name : fight.fighter2.name;
  
  if (!confirm(`–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å –ø–æ–±–µ–¥—É ${winnerName}?`)) {
    return;
  }
  
  fight.status = 'finished';
  fight.winner = winner;
  
  // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å—ã —Å—Ç–∞–≤–æ–∫
  bets.forEach(bet => {
    if (bet.fightId === fightId && bet.status === 'accepted') {
      bet.status = bet.fighter === winner ? 'won' : 'lost';
    }
  });
  
  const [savedFights, savedBets] = await Promise.all([
    saveJSON(KEY_FIGHTS, fights),
    saveJSON(KEY_BETS, bets)
  ]);
  
  if (savedFights && savedBets) {
    alert(`–ü–æ–±–µ–¥–∏—Ç–µ–ª—å —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω: ${winnerName}!`);
    renderAdminFights();
    renderAllBets();
    renderActiveFights();
    renderMyBets();
    renderFinishedFights();
  }
}

function renderAllBets() {
  const list = el('allBetsList');
  
  if (bets.length === 0) {
    list.innerHTML = '<div class="muted">–ù–µ—Ç —Å—Ç–∞–≤–æ–∫</div>';
    return;
  }
  
  bets.sort((a, b) => b.id - a.id);
  
  list.innerHTML = bets.map(bet => {
    const statusClass = `status-${bet.status}`;
    const statusText = getStatusText(bet.status);
    const fight = fights.find(f => f.id === bet.fightId);
    
    let actions = '';
    if (bet.status === 'pending') {
      actions = `
        <button class="btn" onclick="updateBetStatus(${bet.id}, 'accepted')">–ü—Ä–∏–Ω—è—Ç—å</button>
        <button class="ghost" onclick="updateBetStatus(${bet.id}, 'rejected')">–û—Ç–∫–ª–æ–Ω–∏—Ç—å</button>
      `;
    }
    
    return `
      <div class="bet-item">
        <div class="bet-info">
          <strong>${escapeHtml(bet.userId)}</strong>
          <div class="muted">${escapeHtml(bet.fightTitle)}</div>
          <div>–°—Ç–∞–≤–∫–∞ –Ω–∞: ${escapeHtml(bet.fighterName)} - ${bet.amount} üí∞ (–∫–æ—ç—Ñ. ${bet.coefficient}x)</div>
          <div>–ü–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω—ã–π –≤—ã–∏–≥—Ä—ã—à: ${bet.potentialWin} üí∞</div>
          <div class="small-muted">${bet.date}</div>
        </div>
        <div style="text-align:right">
          <div class="bet-status ${statusClass}">${statusText}</div>
          <div style="margin-top:8px">${actions}</div>
        </div>
      </div>
    `;
  }).join('');
}

async function updateBetStatus(betId, status) {
  const bet = bets.find(b => b.id === betId);
  if (bet) {
    bet.status = status;
    const saved = await saveJSON(KEY_BETS, bets);
    if (saved) {
      renderAllBets();
      renderMyBets();
      renderActiveFights();
    }
  }
}

async function createNewFight() {
  const title = el('newFightTitle').value.trim();
  const date = el('newFightDate').value;
  const fighter1 = el('newFighter1').value.trim();
  const coeff1 = parseFloat(el('newCoefficient1').value);
  const fighter2 = el('newFighter2').value.trim();
  const coeff2 = parseFloat(el('newCoefficient2').value);
  
  if (!title || !date || !fighter1 || !fighter2 || !coeff1 || !coeff2) {
    alert('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è');
    return;
  }
  
  const newFight = {
    id: Date.now(),
    title: title,
    fighter1: { name: fighter1, coefficient: coeff1 },
    fighter2: { name: fighter2, coefficient: coeff2 },
    date: date,
    status: 'active',
    winner: null
  };
  
  fights.push(newFight);
  const saved = await saveJSON(KEY_FIGHTS, fights);
  
  if (saved) {
    alert('–ë–æ–π —Å–æ–∑–¥–∞–Ω!');
    // –û—á–∏—â–∞–µ–º –ø–æ–ª—è
    ['newFightTitle', 'newFightDate', 'newFighter1', 'newCoefficient1', 'newFighter2', 'newCoefficient2'].forEach(id => {
      el(id).value = '';
    });
    
    renderAdminFights();
    renderActiveFights();
  }
}

// –£—Ç–∏–ª–∏—Ç—ã
function escapeHtml(unsafe) {
  if (!unsafe) return '';
  return unsafe.toString()
    .replace(/&/g, "&amp;")
    .replace(/</g, "&lt;")
    .replace(/>/g, "&gt;")
    .replace(/"/g, "&quot;")
    .replace(/'/g, "&#039;");
}

function getStatusText(status) {
  const statusMap = {
    'pending': '‚è≥ –û–∂–∏–¥–∞–Ω–∏–µ',
    'accepted': '‚úÖ –ü—Ä–∏–Ω—è—Ç–∞', 
    'rejected': '‚ùå –û—Ç–∫–ª–æ–Ω–µ–Ω–∞',
    'won': 'üèÜ –í—ã–∏–≥—Ä–∞–ª–∞',
    'lost': 'üí∏ –ü—Ä–æ–∏–≥—Ä–∞–ª–∞'
  };
  return statusMap[status] || status;
}

function updateUI() {
  if (currentUser) {
    el('btnLogin').style.display = 'none';
    el('btnMyBets').style.display = 'inline-block';
  } else {
    el('btnLogin').style.display = 'inline-block';
    el('btnMyBets').style.display = 'none';
  }
}

function showLogin() {
  el('loginPanel').style.display = 'block';
}

function hideLogin() {
  el('loginPanel').style.display = 'none';
}

// –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π
el('btnLogin').addEventListener('click', showLogin);
el('btnMyBets').addEventListener('click', () => switchTab('mybets'));
el('btnCreateFight').addEventListener('click', createNewFight);

el('btnBetLogin').addEventListener('click', async () => {
  const username = el('betUsername').value.trim();
  const password = el('betPassword').value.trim();
  
  users = await loadJSON(KEY_USERS, users);
  if (!users[username] || users[username].password !== password) {
    alert('–ù–µ–≤–µ—Ä–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ');
    return;
  }
  
  currentUser = username;
  localStorage.setItem(KEY_CURRENT_USER, username);
  updateUI();
  hideLogin();
  renderMyBets();
  renderActiveFights();
  alert('–í—Ö–æ–¥ –≤—ã–ø–æ–ª–Ω–µ–Ω!');
});

el('btnBetRegister').addEventListener('click', async () => {
  const username = el('betUsername').value.trim();
  const password = el('betPassword').value.trim();
  
  if (!username || !password) {
    alert('–í–≤–µ–¥–∏—Ç–µ –ª–æ–≥–∏–Ω –∏ –ø–∞—Ä–æ–ª—å');
    return;
  }
  
  users = await loadJSON(KEY_USERS, users);
  if (users[username]) {
    alert('–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç');
    return;
  }
  
  users[username] = { password: password, orders: [] };
  const saved = await saveJSON(KEY_USERS, users);
  
  if (saved) {
    alert('–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–æ!');
    currentUser = username;
    localStorage.setItem(KEY_CURRENT_USER, username);
    updateUI();
    hideLogin();
  }
});

// –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –≤–∫–ª–∞–¥–æ–∫
function switchTab(tabName) {
  document.querySelectorAll('.tab-content').forEach(tab => tab.style.display = 'none');
  document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
  
  el(`${tabName}Tab`).style.display = 'block';
  document.querySelector(`[data-tab="${tabName}"]`).classList.add('active');
}

document.querySelectorAll('[data-tab]').forEach(tab => {
  tab.addEventListener('click', function() {
    switchTab(this.dataset.tab);
  });
});

// –ê–¥–º–∏–Ω –≤–∫–ª–∞–¥–∫–∏
document.querySelectorAll('[data-admin-tab]').forEach(tab => {
  tab.addEventListener('click', function() {
    document.querySelectorAll('.admin-tab-content').forEach(content => content.style.display = 'none');
    document.querySelectorAll('[data-admin-tab]').forEach(t => t.classList.remove('active'));
    
    el(`${this.dataset.adminTab}Tab`).style.display = 'block';
    this.classList.add('active');
    
    if (this.dataset.adminTab === 'manageBets') {
      renderAllBets();
    }
  });
});

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
initializeData();
</script>
</body>
</html>
